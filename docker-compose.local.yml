# ================================
# Local Development Compose
# - API + nginx + prometheus + blackbox + node_exporter + cadvisor + grafana + redis
# - SQLite ÏÇ¨Ïö© (USE_SQLITE=1)
# - Î∞∞Ìè¨ÏôÄ Ï†àÎåÄ Ï∂©Îèå ÏóÜÏùå
# ================================

services:
  api:
    build:
      context: .
      dockerfile: Dockerfile
    image: team2/api:local
    container_name: team2_local_api
    env_file: .env                 # Î°úÏª¨ÏùÄ .env ÏÇ¨Ïö©
    environment:
      IN_DOCKER: "1"
      DJANGO_SETTINGS_MODULE: team2_final.settings
      DJANGO_DEBUG: "true"
      USE_SQLITE: "1"              # üî• Î°úÏª¨ÏùÄ Î¨¥Ï°∞Í±¥ SQLite
      DJANGO_ALLOWED_HOSTS: "127.0.0.1,localhost,nginx,team2_nginx,api,host.docker.internal,team2_local_nginx"
      # üî• Redis Ï∫êÏã±Ïö© (Django settings.pyÏóêÏÑú REDIS_URL ÏùΩÏñ¥ÏÑú ÏÇ¨Ïö©)
      REDIS_URL: redis://redis:6379/0
    command: >
      bash -lc "
        python manage.py migrate --noinput &&
        python manage.py collectstatic --noinput &&
        exec gunicorn team2_final.wsgi:application --bind 0.0.0.0:8000 --workers 2 --threads 2 --timeout 60
      "
    volumes:
      - .:/app
      - ./static:/app/static
      - ./media:/app/media
    ports:
      - "8000:8000"
    restart: unless-stopped
    networks:
      - team2_local_net

  nginx:
    image: nginx:1.27
    container_name: team2_local_nginx
    depends_on:
      - api
    ports:
      - "80:80"
    volumes:
      - ./deploy/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./deploy/nginx/conf.d:/etc/nginx/conf.d:ro
    restart: unless-stopped
    networks:
      - team2_local_net

  blackbox:
    image: prom/blackbox-exporter:latest
    container_name: team2_local_blackbox
    volumes:
      - ./blackbox.yml:/etc/blackbox_exporter/config.yml:ro
    ports:
      - "9115:9115"
    restart: unless-stopped
    networks:
      - team2_local_net

  prometheus:
    image: prom/prometheus:latest
    container_name: team2_local_prometheus
    command:
      - --config.file=/etc/prometheus/prometheus.yml
      - --storage.tsdb.path=/prometheus
      - --storage.tsdb.retention.time=7d
      - --storage.tsdb.retention.size=5GB
      - --web.enable-lifecycle
    volumes:
      - ./prometheus.local.yml:/etc/prometheus/prometheus.yml:ro
      - ./prometheus/rules:/etc/prometheus/rules:ro
      - prom-local-data:/prometheus
    ports:
      - "9090:9090"
    restart: unless-stopped
    networks:
      - team2_local_net

  node_exporter:
    image: prom/node-exporter:latest
    container_name: node_exporter_local
    command:
      - '--path.rootfs=/host'
    volumes:
      - '/:/host:ro'
    expose:
      - "9100"
    restart: unless-stopped
    networks:
      - team2_local_net

  cadvisor:
    image: gcr.io/cadvisor/cadvisor:latest
    container_name: cadvisor_local
    privileged: true
    volumes:
      - '/:/rootfs:ro'
      - '/var/run:/var/run:ro'
      - '/sys:/sys:ro'
      - '/var/lib/docker/:/var/lib/docker:ro'
      - '/dev/disk/:/dev/disk:ro'
    expose:
      - "8080"
    restart: unless-stopped
    networks:
      - team2_local_net

  grafana:
    image: grafana/grafana:10.2.3
    container_name: grafana_local
    depends_on:
      - prometheus
    environment:
      - GF_SERVER_ROOT_URL=http://localhost:3000/grafana
      - GF_SERVER_SERVE_FROM_SUB_PATH=true
    ports:
      - "3000:3000"
    volumes:
      - ./grafana-data:/var/lib/grafana
    restart: unless-stopped
    networks:
      - team2_local_net

  # üî• Redis (Î°úÏª¨ Ï∫êÏã±Ïö©) - DjangoÏóêÏÑú REDIS_URLÎ°ú Ï†ëÍ∑º
  redis:
    image: redis:7-alpine
    container_name: team2_local_redis
    command: ["redis-server", "--appendonly", "no"]
    restart: unless-stopped
    networks:
      - team2_local_net

volumes:
  prom-local-data:

networks:
  team2_local_net:
    driver: bridge
