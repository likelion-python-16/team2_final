# deploy/nginx/default.conf
server {
  listen 80 default_server;
  server_name _;

  client_max_body_size 10M;
  add_header X-Debug-Via "nginx-default" always;

  # 헬스(정적 200)
  default_type text/plain;
  location = /healthz           { return 200 "ok\n"; }
  location = /probe/healthz     { return 200 "ok\n"; }
  location = /probe/api-healthz { return 200 "ok\n"; }

  # 나머지는 모두 Django API로 프록시
  location / {
    proxy_pass           http://api:8000;
    proxy_redirect       off;
    proxy_set_header     Host               $host;
    proxy_set_header     X-Real-IP          $remote_addr;
    proxy_set_header     X-Forwarded-For    $proxy_add_x_forwarded_for;
    proxy_set_header     X-Forwarded-Proto  $scheme;
    proxy_http_version   1.1;
    proxy_set_header     Connection         "";
    proxy_connect_timeout 2s;
    proxy_read_timeout    30s;
    proxy_send_timeout    30s;
    proxy_next_upstream   error timeout http_502 http_503 http_504;
    proxy_next_upstream_tries 2;
  }
}
