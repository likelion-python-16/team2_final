user  nginx;
worker_processes  auto;

events { worker_connections 1024; }

http {
  include       /etc/nginx/mime.types;
  default_type  application/octet-stream;

  sendfile on;
  keepalive_timeout 65;
  client_max_body_size 20m;

  # gzip
  gzip on;
  gzip_comp_level 5;
  gzip_min_length 1024;
  gzip_types
    text/plain text/css text/javascript application/javascript application/json
    application/xml application/rss+xml image/svg+xml;
  gzip_vary on;

  # Docker DNS (변수 기반 proxy_pass를 위한 런타임 해석 보조)
  resolver 127.0.0.11 valid=10s ipv6=off;

  server {
    listen 80;
    server_name _;

    # 여기서 변수 선언 (http 블록이 아니라 server/loc)
    set $api_origin http://api:8000;

    add_header X-Debug-Via "nginx-http" always;
    add_header X-Frame-Options DENY;
    add_header X-Content-Type-Options nosniff;
    add_header Referrer-Policy same-origin;

    # 인프라 헬스: 항상 200
    location = /healthz {
      add_header Content-Type text/plain;
      return 200 ok;
    }

    # 앱 헬스: 실제 API 헬스
    location = /probe/api-healthz {
      proxy_pass             $api_origin/healthz;
      proxy_set_header       Host "localhost";
      proxy_set_header       X-Real-IP $remote_addr;
      proxy_set_header       X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header       X-Forwarded-Proto $scheme;
      proxy_http_version     1.1;
      proxy_set_header       Connection "";
      proxy_connect_timeout  2s;
      proxy_read_timeout     30s;
      proxy_send_timeout     30s;
      proxy_next_upstream    error timeout http_502 http_503 http_504;
      proxy_next_upstream_tries 2;
      proxy_redirect         off;
      access_log off;
    }

    # 정적: 7일 캐시 + immutable
    location ^~ /static/ {
      proxy_pass             $api_origin;
      proxy_set_header       Host $host;
      proxy_set_header       X-Real-IP $remote_addr;
      proxy_set_header       X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header       X-Forwarded-Proto $scheme;
      proxy_http_version     1.1;
      proxy_set_header       Connection "";
      add_header Cache-Control "public, max-age=604800, immutable" always;
    }

    # 토큰: 캐시 금지
    location = /auth/token/ {
      proxy_pass             $api_origin/auth/token/;
      proxy_set_header       Host $host;
      proxy_set_header       X-Real-IP $remote_addr;
      proxy_set_header       X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header       X-Forwarded-Proto $scheme;
      proxy_http_version     1.1;
      proxy_set_header       Connection "";
      add_header Cache-Control "no-store" always;
    }

    # API 전역
    location ^~ /api/ {
      proxy_pass             $api_origin;
      proxy_set_header       Host $host;
      proxy_set_header       X-Real-IP $remote_addr;
      proxy_set_header       X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header       X-Forwarded-Proto $scheme;
      proxy_http_version     1.1;
      proxy_set_header       Connection "";
      add_header Cache-Control "no-store" always;
    }

    # 기본 프록시
    location / {
      proxy_pass             $api_origin;
      proxy_set_header       Host $host;
      proxy_set_header       X-Real-IP $remote_addr;
      proxy_set_header       X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header       X-Forwarded-Proto $scheme;
      proxy_http_version     1.1;
      proxy_set_header       Connection "";
      proxy_connect_timeout  2s;
      proxy_read_timeout     30s;
      proxy_send_timeout     30s;
      proxy_next_upstream    error timeout http_502 http_503 http_504;
      proxy_next_upstream_tries 2;
      proxy_redirect         off;
    }
  }
}
