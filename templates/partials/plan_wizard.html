<!-- templates/partials/plan_wizard.html -->
<style>
  /* === 모달 오버레이 & 컨텐트 (최상단 보장) === */
  #plan-modal{
    position: fixed; inset: 0; display: none;
    align-items: center; justify-content: center;
    background: rgba(0,0,0,.45);
    z-index: 2147483647;
  }
  #plan-modal .modal-content{
    background:#fff; width:min(840px,92vw); max-height:92vh;
    border-radius:12px; padding:16px 20px; overflow:hidden;
    box-shadow:0 10px 40px rgba(0,0,0,.25);
  }

  /* === 위자드 레이아웃/스크롤 === */
  #plan-wizard{ display:flex; flex-direction:column; gap:12px; overflow-y:auto; max-height:100%; }
  #plan-wizard .wizard-header{ display:flex; justify-content:space-between; align-items:center; gap:8px; }
  #plan-wizard .wizard-body{ overflow-y:auto; max-height: calc(92vh - 140px); }
  #plan-wizard .wizard-actions{
    position: sticky; bottom: 0;
    background: linear-gradient(to top, rgba(255,255,255,.98) 60%, rgba(255,255,255,0));
    backdrop-filter: blur(2px);
    border-top: 1px solid #e5e7eb;
    padding-top: 12px; margin-top: 8px; z-index: 1;
    display:flex; gap:8px; justify-content:flex-end;
  }

  /* === 하늘색 카드 + 글자 검정 === */
  #plan-wizard fieldset.card{
    background:#e0f2fe; border:1px solid #93c5fd; border-radius:12px;
    padding:8px; box-shadow:0 8px 24px rgba(2,6,23,.08);
  }
  #plan-wizard fieldset.card,
  #plan-wizard fieldset.card *,
  #plan-wizard fieldset.card > legend{ color:#000 !important; }
  #plan-wizard fieldset.card > legend{
    background:#dbeafe; border:1px solid #93c5fd;
    border-radius:8px; padding:2px 8px; font-weight:700;
  }
  #plan-wizard fieldset.card .form-row{
    display:grid; grid-template-columns:110px 1fr;
    gap:8px; align-items:center; margin:6px 0;
  }
  #plan-wizard fieldset.card input[type="number"],
  #plan-wizard fieldset.card input[type="text"],
  #plan-wizard fieldset.card select{
    background:#fff; color:#000 !important; border:1px solid #93c5fd;
    border-radius:8px; padding:6px 8px;
  }

  /* 스크린리더 전용 */
  .sr-only {
    position:absolute !important;
    width:1px;height:1px;
    padding:0;margin:-1px;overflow:hidden;
    clip:rect(0,0,0,0);white-space:nowrap;border:0;
  }
</style>

<div class="modal" id="plan-modal" style="display:none" aria-hidden="true">
  <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="pw-title">
    <section id="plan-wizard" class="wizard" aria-describedby="pw-desc">
      <!-- 헤더 -->
      <header class="wizard-header">
        <div>
          <h3 id="pw-title" style="margin:0;">Plan Wizard</h3>
          <p id="pw-desc" class="muted" style="margin:2px 0 0;">타겟 선택 → 운동 선택 → 파라미터 설정 → Task 생성</p>
        </div>
        <button type="button" class="btn btn--ghost" id="btn-close-wizard" aria-label="닫기">✕</button>
      </header>

      <!-- 라이브 알림 영역 -->
      <div id="wizard-aria-live" class="sr-only" aria-live="polite" aria-atomic="true"></div>

      <!-- 본문(스크롤) -->
      <div class="wizard-body">
        <section aria-labelledby="pw-targets-title">
          <h4 id="pw-targets-title">Targets</h4>
          <div id="pw-targets" aria-busy="false">Loading...</div>
        </section>

        <section id="step-exercises" aria-labelledby="pw-exercises-title" style="display:none; margin-top:12px;">
          <h4 id="pw-exercises-title">Exercises (<span id="pw-picked-target"></span>)</h4>
          <div id="pw-ex-list" aria-busy="false"></div>
        </section>

        <section aria-labelledby="pw-params-title" style="margin-top:12px;">
          <h4 id="pw-params-title">Params</h4>
          <div id="pw-params"><em>운동을 선택하세요</em></div>
        </section>
      </div>

      <!-- 하단 고정 액션바 -->
      <div class="wizard-actions" data-actions>
        <button id="btn-create-tasks" class="btn btn--primary" aria-controls="pw-params">선택 항목으로 Task 생성</button>
        <button id="btn-cancel-wizard" class="btn btn--ghost">닫기</button>
      </div>
    </section>
  </div>
</div>

<script>
(function(){
  const API      = window.API || "/api";
  const $modal   = document.getElementById('plan-modal');
  const $wizard  = document.getElementById('plan-wizard');
  const $targets = document.getElementById('pw-targets');
  const $exList  = document.getElementById('pw-ex-list');
  const $params  = document.getElementById('pw-params');
  const $picked  = document.getElementById('pw-picked-target');
  const $live    = document.getElementById('wizard-aria-live');

  function announce(msg){
    if(!$live) return;
    $live.textContent = '';
    setTimeout(()=>{ $live.textContent = msg; }, 10);
  }

  // CSRF
  function getCookie(name){
    const m = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
    return m ? m.pop() : '';
  }

  // 안전 헤더
  const _authHeaders = (typeof window.authHeaders === 'function')
    ? window.authHeaders
    : () => {
        const headers = { 'Content-Type': 'application/json' };
        const csrf = getCookie('csrftoken');
        if (csrf) headers['X-CSRFToken'] = csrf;
        return headers;
      };

  // 모달을 body 직속으로
  if ($modal && $modal.parentElement !== document.body) {
    document.body.appendChild($modal);
  }

  // 배경 inert 처리 (모달 형제만)
  let inertTargets = [];
  function trapBackground(enable) {
    const scope = $modal?.parentElement || document.body;
    inertTargets = Array.from(scope.children).filter(el => el !== $modal);
    inertTargets.forEach(el => {
      if (enable) el.setAttribute('inert', '');
      else el.removeAttribute('inert');
    });
  }

  // 포커스 저장/복원
  let lastActive = null;

  // 열기
  function openPlanWizard() {
    if (!window.currentPlan || !window.currentPlan.id) {
      alert('오늘 플랜을 먼저 생성해 주세요. 상단의 "Generate New Plan" 버튼으로 보장하세요.');
      return;
    }
    lastActive = document.activeElement instanceof HTMLElement ? document.activeElement : null;

    $modal.style.display = 'flex';
    $modal.removeAttribute('aria-hidden');

    trapBackground(true);

    const focusTarget = $wizard || $modal.querySelector('[role="dialog"]');
    if (focusTarget) {
      focusTarget.setAttribute('tabindex','-1');
      requestAnimationFrame(() => focusTarget.focus());
    }

    const step = document.getElementById('step-exercises');
    if (step) step.style.display = 'none';
    $exList.textContent = '';
    $params.innerHTML = '<em>운동을 선택하세요</em>';

    announce('플랜 위자드가 열렸습니다.');
    loadTargets();
  }

  // 닫기
  function closePlanWizard() {
    const active = document.activeElement;
    if (active && $modal.contains(active) && typeof active.blur === 'function') {
      active.blur();
    }

    trapBackground(false);

    const fallback = document.getElementById('wk-ensure-today');
    let target = (lastActive && lastActive.isConnected) ? lastActive : fallback;
    if (!target) target = document.querySelector('main, [role="main"]') || document.body;
    if (target && typeof target.focus === 'function') {
      if (!target.hasAttribute('tabindex')) target.setAttribute('tabindex','-1');
      target.focus({ preventScroll: true });
    }

    requestAnimationFrame(() => {
      $modal.setAttribute('aria-hidden','true');
      $modal.style.display = 'none';
    });

    announce('플랜 위자드가 닫혔습니다.');
  }

  window.openPlanWizard  = openPlanWizard;
  window.closePlanWizard = closePlanWizard;

  // 닫기 바인딩/ESC/오버레이
  document.getElementById('btn-close-wizard')?.addEventListener('click', closePlanWizard);
  document.getElementById('btn-cancel-wizard')?.addEventListener('click', closePlanWizard);
  $modal.addEventListener('click', (e) => { if (e.target === $modal) closePlanWizard(); });
  document.addEventListener('keydown', (e) => {
    const opened = $modal && $modal.style.display !== 'none';
    if (opened && e.key === 'Escape') closePlanWizard();
  });

  // 1) 타겟 목록
  async function loadTargets() {
    $targets.setAttribute('aria-busy','true');
    $targets.textContent = 'Loading...';
    try {
      const res = await fetch(`${API}/exercises/targets/`, {
        headers: _authHeaders(),
        credentials: 'same-origin',
      });
      if (res.status === 401) { $targets.innerHTML = '로그인이 필요합니다'; return; }
      const data = await res.json();
      const targets = Array.isArray(data) ? data : (Array.isArray(data?.results) ? data.results : []);
      if (!targets.length) { $targets.innerHTML = '<em>No targets</em>'; return; }

      // 버튼들에 id/aria-pressed 부여
      $targets.innerHTML = targets.map((t, i) => `
        <button class="btn btn--ghost" id="pw-target-${i}" data-target="${t}" aria-pressed="false">${t}</button>
      `).join(' ');
      $targets.querySelectorAll('button').forEach(btn => {
        btn.addEventListener('click', () => loadExercises(btn.dataset.target, btn));
      });
      announce('타겟 목록이 로드되었습니다.');
    } catch (e) {
      console.error(e);
      $targets.innerHTML = '<em>로드 실패</em>';
      announce('타겟 목록을 불러오지 못했습니다.');
    } finally {
      $targets.setAttribute('aria-busy','false');
    }
  }

  // 2) 타겟별 운동 목록
  async function loadExercises(target, btnEl) {
    if (btnEl) {
      // aria-pressed 토글
      $targets.querySelectorAll('button[aria-pressed]').forEach(b => b.setAttribute('aria-pressed','false'));
      btnEl.setAttribute('aria-pressed', 'true');
    }
    $picked.textContent = target;
    const step = document.getElementById('step-exercises');
    step.style.display = '';
    $exList.setAttribute('aria-busy','true');
    $exList.innerHTML = 'Loading...';
    try {
      const res = await fetch(`${API}/exercises/?target=${encodeURIComponent(target)}`, {
        headers: _authHeaders(),
        credentials: 'same-origin',
      });
      if (res.status === 401) { $exList.innerHTML = '로그인이 필요합니다'; return; }
      const data = await res.json();
      const items = Array.isArray(data) ? data : (Array.isArray(data?.results) ? data.results : []);
      if (!items.length) {
        $exList.innerHTML = '<em>해당 타겟의 운동이 없습니다</em>';
        announce(`${target} 타겟의 운동이 없습니다.`);
        renderParamEditors([]); // 파라미터 영역 초기화
        return;
      }

      // 체크박스 + label for/id 매핑
      $exList.innerHTML = items.map((x, idx) => {
        const cid = `ex-${x.id}-${idx}`;
        return `
          <div class="form-row" style="grid-template-columns:24px 1fr;">
            <input id="${cid}" type="checkbox" name="ex" value="${x.id}" data-name="${x.name}" aria-labelledby="${cid}-lbl">
            <label id="${cid}-lbl" for="${cid}">${x.name} <small>(${x.target})</small></label>
          </div>
        `;
      }).join('');

      renderParamEditors(items);
      announce(`${target} 타겟의 운동 목록이 로드되었습니다.`);
    } catch (e) {
      console.error(e);
      $exList.innerHTML = '<em>로드 실패</em>';
      announce('운동 목록을 불러오지 못했습니다.');
    } finally {
      $exList.setAttribute('aria-busy','false');
    }
  }

  // 3) 선택 파라미터 편집 UI
  function renderParamEditors(items) {
    const pickedIds = new Set();
    $exList.querySelectorAll('input[name="ex"]').forEach(chk => {
      chk.addEventListener('change', () => {
        if (chk.checked) pickedIds.add(+chk.value); else pickedIds.delete(+chk.value);
        drawParams([...pickedIds]);
        announce(chk.checked ? '운동이 선택되었습니다.' : '운동 선택이 해제되었습니다.');
      });
    });
    drawParams([]);
  }

  function drawParams(ids) {
    if (!ids.length) { $params.innerHTML = '<em>운동을 선택하세요</em>'; return; }
    // 각 입력마다 고유 id를 생성
    const rows = ids.map((id, i) => {
      const rowId = `ex-${id}`;
      const idOrder = `${rowId}-order`;
      const idDur   = `${rowId}-duration`;
      const idSets  = `${rowId}-sets`;
      const idReps  = `${rowId}-reps`;
      const idInt   = `${rowId}-intensity`;
      const idNote  = `${rowId}-notes`;
      const hintId  = `${rowId}-hint`;

      return `
      <fieldset class="card" data-ex="${id}" style="margin:8px 0;padding:8px;" aria-describedby="${hintId}">
        <legend>Exercise #${id}</legend>

        <div id="${hintId}" class="sr-only">아래 필드를 채워 생성 버튼을 누르면 Task가 만들어집니다.</div>

        <div class="form-row">
          <label for="${idOrder}">순서</label>
          <input id="${idOrder}" name="order" type="number" value="${i+1}" min="1" inputmode="numeric">
        </div>

        <div class="form-row">
          <label for="${idDur}">시간(분)</label>
          <input id="${idDur}" name="duration" type="number" value="20" min="1" inputmode="numeric">
        </div>

        <div class="form-row">
          <label for="${idSets}">세트</label>
          <input id="${idSets}" name="sets" type="number" value="3" min="1" inputmode="numeric">
        </div>

        <div class="form-row">
          <label for="${idReps}">반복</label>
          <input id="${idReps}" name="reps" type="number" value="10" min="1" inputmode="numeric">
        </div>

        <div class="form-row">
          <label for="${idInt}">강도</label>
          <select id="${idInt}" name="intensity">
            <option value="low">low</option>
            <option value="medium" selected>medium</option>
            <option value="high">high</option>
          </select>
        </div>

        <div class="form-row">
          <label for="${idNote}">비고</label>
          <input id="${idNote}" name="notes" type="text" placeholder="">
        </div>

        <input name="exercise_id" type="hidden" value="${id}">
      </fieldset>`;
    });

    $params.innerHTML = rows.join('');
  }

  // 4) TaskItem 생성 → 화면 갱신
  document.getElementById('btn-create-tasks')?.addEventListener('click', async () => {
    if (!window.currentPlan) return alert('Plan not loaded. 먼저 플랜을 생성/불러오세요.');
    const groups = Array.from(document.querySelectorAll('#pw-params fieldset'));
    if (!groups.length) return alert('선택된 운동이 없습니다.');

    announce('선택된 항목으로 Task를 생성합니다.');

    const payloads = groups.map((g, idx) => {
      const get = (name) => g.querySelector(`[name=${name}]`)?.value;
      let intensity = get('intensity') || 'medium';
      if (intensity === 'mid') intensity = 'medium';
      return {
        workout_plan: window.currentPlan.id,
        exercise: +get('exercise_id'),
        duration_min: +get('duration') || 0,
        target_sets: +get('sets') || 0,
        target_reps: +get('reps') || 0,
        intensity,
        notes: get('notes') || '',
        is_ai_recommended: false,
        order: +get('order') || (idx + 1),
      };
    });

    let ok = 0, fail = 0;
    for (const body of payloads) {
      try {
        const r = await fetch(`${API}/taskitems/`, {
          method: 'POST',
          headers: _authHeaders(),
          credentials: 'same-origin',
          body: JSON.stringify(body),
        });
        if (r.ok) ok++; else fail++;
      } catch (e) {
        fail++;
      }
    }

    if (ok) announce(`Task ${ok}개가 생성되었습니다.`);
    if (fail) announce(`Task ${fail}개 생성에 실패했습니다.`);

    alert(`Created ${ok}/${payloads.length} tasks`);
    if (!ok) return;

    try {
      if (window.currentPlan?.id) {
        const r = await fetch(`${API}/workoutplans/${window.currentPlan.id}/`, {
          headers: _authHeaders(),
          credentials: 'same-origin',
        });
        if (r.ok) {
          const detail = await r.json();
          window.currentPlan = detail;
          window.dispatchEvent(new CustomEvent('plan:updated', { detail }));
        }
      }

      if (typeof window.reloadPlanFor === 'function') {
        const d =
          (typeof window.getSelectedDate === 'function' && window.getSelectedDate()) ||
          (window.selectedDate instanceof Date && window.selectedDate) ||
          new Date();
        window.reloadPlanFor(d);
      }

      if (typeof window.closePlanWizard === 'function') {
        window.closePlanWizard();
      }
    } catch (e) {
      announce('생성 후 갱신 과정에서 오류가 발생했습니다.');
    }
  });

  // 외부 버튼에서도 열리게(선택)
  const btnEnsure = document.getElementById('wk-ensure-today');
  if (btnEnsure) {
    btnEnsure.addEventListener('click', (e) => {
      if (typeof window.openPlanWizard !== 'function') {
        e.preventDefault();
        openPlanWizard();
      }
    });
  }
})();
</script>
