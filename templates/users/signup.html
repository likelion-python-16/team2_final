{% extends "base.html" %}
{% load static %}
{% block title %}회원가입{% endblock %}

{% block extra_head %}
  {{ block.super }}
  <link rel="stylesheet" href="{% static 'css/styles.css' %}">
{% endblock %}

{% block content %}
<div class="auth-shell">
  <div class="auth-grid">
    <!-- 메인 패널 -->
    <section class="auth-panel" aria-labelledby="signupTitle">
      <div class="auth-form">
        <div class="auth-logo" aria-hidden="true">H</div>

        <header class="auth-header">
          <h1 id="signupTitle">Create your account</h1>
          <p>Start your training & nutrition journey</p>
        </header>

        <div class="auth-divider"><span>Sign up</span></div>

        <!-- JS 기반 회원가입 -->
        <form id="signupForm" class="auth-fields" novalidate>
          {% csrf_token %}

          {% if next %}
            <input type="hidden" name="next" value="{{ next }}">
          {% else %}
            <input type="hidden" name="next" value="{% url 'tasks:dashboard' %}">
          {% endif %}

          <label class="auth-field" for="id_username">
            <span>Username</span>
            <input
              type="text"
              name="username"
              id="id_username"
              class="auth-input"
              placeholder="아이디(영문/숫자)"
              required
              autocomplete="username"
              inputmode="latin"
            />
          </label>

          <label class="auth-field" for="id_nickname">
            <span>Nickname</span>
            <input
              type="text"
              name="nickname"
              id="id_nickname"
              class="auth-input"
              placeholder="표시할 이름"
              required
              autocomplete="nickname"
            />
          </label>

          <label class="auth-field" for="id_email">
            <span>Email</span>
            <input
              type="email"
              name="email"
              id="id_email"
              class="auth-input"
              placeholder="you@example.com"
              required
              autocomplete="email"
              inputmode="email"
            />
          </label>

          <label class="auth-field" for="id_password">
            <span>Password</span>
            <input
              type="password"
              name="password"
              id="id_password"
              class="auth-input auth-input--password"
              placeholder="비밀번호(8자 이상)"
              required
              autocomplete="new-password"
              minlength="8"
            />
          </label>

          <!-- 서버가 password2 요구 시 자동 노출 -->
          <div id="password2Wrap" class="auth-field" style="display:none">
            <span>Confirm Password</span>
            <input
              type="password"
              name="password2"
              id="id_password2"
              class="auth-input"
              placeholder="비밀번호 확인"
              autocomplete="new-password"
            />
          </div>

          <button type="submit" class="auth-submit" id="signupSubmitBtn" aria-busy="false">
            <span class="btn-label">Create account</span>
            <span class="btn-spinner" aria-hidden="true"></span>
          </button>

          <!-- 접근성: 실시간 피드백 -->
          <div class="auth-error" id="signupErr" style="display:none;margin-top:.75rem;" role="alert" aria-live="polite"></div>
          <div class="auth-success" id="signupOk" style="display:none;margin-top:.75rem;" role="status" aria-live="polite">
            가입 성공! 로그인 페이지로 이동합니다…
          </div>

          <noscript>
            <p class="auth-hint">자바스크립트가 비활성화되어 있어요. 관리자가 제공하는 회원가입 페이지를 이용해 주세요.</p>
          </noscript>
        </form>

        <p class="auth-footer" style="margin-top:1rem;">
          이미 계정이 있으신가요?
          <a href="{% url 'login' %}{% if next %}?next={{ next|urlencode }}{% endif %}" class="auth-link">Sign in</a>
        </p>
      </div>
    </section>

    <!-- 사이드 패널 -->
    <aside class="auth-side" aria-label="Signup benefits">
      <div class="auth-side__quote">
        <blockquote>
          <p>“Smooth signup, instant login.”</p>
        </blockquote>
        <ul class="auth-side__bullets">
          <li>하루 플랜 & 진행률 자동 동기화</li>
          <li>식단 분석과 맞춤 추천</li>
          <li>JWT 로그인으로 빠른 API 연동</li>
        </ul>
      </div>
    </aside>
  </div>
</div>
{% endblock %}

{% block extra_js %}
  {{ block.super }}
  <script>
  (function () {
    const $ = (s, ctx=document) => ctx.querySelector(s);
    const form = $("#signupForm");
    if (!form) return;

    const btn = $("#signupSubmitBtn");
    const elErr = $("#signupErr");
    const elOk  = $("#signupOk");
    const pw2Wrap = $("#password2Wrap");

    // ✅ 공개 회원가입 표준 엔드포인트 (단일 선언)
    const REGISTER_CANDIDATES = ["/auth/register/"];

    function showErr(msg){
      if(!elErr) return;
      elErr.textContent = msg || "가입에 실패했습니다.";
      elErr.style.display="block";
    }
    function clearErr(){ if(elErr){ elErr.style.display="none"; elErr.textContent=""; } }

    function showOk(msg){
      if(!elOk) return;
      elOk.textContent = msg || "가입 성공!";
      elOk.style.display="block";
    }
    function clearOk(){ if(elOk){ elOk.style.display="none"; elOk.textContent=""; } }

    function setLoading(flag){
      if(!btn) return;
      btn.disabled = !!flag;
      btn.classList.toggle("is-loading", !!flag);
      btn.setAttribute("aria-busy", !!flag);
    }

    function getCsrf(){
      const m=document.cookie.match(/(?:^|; )csrftoken=([^;]+)/);
      return m ? decodeURIComponent(m[1]) : "";
    }

    function extractErrorMessage(payload, fallbackText){
      if (!payload) return fallbackText || "요청이 거절되었습니다.";

      // DRF 표준 에러 포맷을 깔끔하게 병합
      const lines = [];
      const push = (k, v) => lines.push(`${k}: ${Array.isArray(v) ? v.join(", ") : String(v)}`);

      // 대표 키 우선 노출
      if (payload.detail) lines.push(String(payload.detail));
      if (payload.message) lines.push(String(payload.message));
      if (payload.non_field_errors) push("non_field_errors", payload.non_field_errors);

      // 필드별 에러
      for (const k of ["username", "nickname", "email", "password", "password2", "re_password"]) {
        if (payload[k]) push(k, payload[k]);
      }

      // 기타 잔여 키
      for (const [k, v] of Object.entries(payload)) {
        if (["detail","message","non_field_errors","username","nickname","email","password","password2","re_password"].includes(k)) continue;
        push(k, v);
      }

      return lines.length ? lines.join(" | ") : (fallbackText || "요청이 거절되었습니다.");
    }

    async function postJson(url, body){
      const res = await fetch(url, {
        method: "POST",
        headers: {
          "Content-Type":"application/json",
          "Accept":"application/json",
          "X-CSRFToken": getCsrf()
        },
        credentials: "same-origin",
        body: JSON.stringify(body)
      });

      const text = await res.text();
      let data = null;
      try { data = text ? JSON.parse(text) : null; } catch {}

      if (!res.ok){
        const msg = extractErrorMessage(data, text || ("HTTP " + res.status));
        const err = new Error(String(msg));
        err.status = res.status; err.payload = data;
        throw err;
      }
      return data;
    }

    // 서버 스펙 자동탐지: 기본 + password2/re_password 호환
    async function tryRegister(username, nickname, email, password){
      const payloads = [
        { username, nickname, email, password },                                    // 표준(우리 서버)
        { username, nickname, email, password1: password, password2: password },    // password1/2 스펙 서버
        { username, nickname, email, password, re_password: password },             // re_password 스펙 서버
      ];
      let lastErr;
      for (const url of REGISTER_CANDIDATES){
        for (const body of payloads){
          try{
            const data = await postJson(url, body);
            if ("password1" in body) pw2Wrap && (pw2Wrap.style.display="");
            return { url, body, data };
          }catch(e){
            lastErr = e;
            const m = String(e?.message||"").toLowerCase();
            if (m.includes("password2") || m.includes("password1")) {
              if (pw2Wrap && pw2Wrap.style.display === "none") pw2Wrap.style.display="";
            }
          }
        }
      }
      throw lastErr || new Error("No registration endpoint matched.");
    }

    form.addEventListener("submit", async (e)=>{
      e.preventDefault();
      clearErr(); clearOk();

      const username = ($("#id_username")?.value || "").trim();
      const nickname = ($("#id_nickname")?.value || "").trim();
      const email    = ($("#id_email")?.value || "").trim();
      const password = ($("#id_password")?.value || "");
      const password2= ($("#id_password2")?.value || "");
      const nextUrl  = (form.querySelector('input[name="next"]')?.value || "{% url 'tasks:dashboard' %}");

      if (!username || !nickname || !email || !password){
        showErr("모든 필드를 입력해 주세요.");
        return;
      }
      if (password.length < 8){
        showErr("비밀번호는 8자 이상이어야 합니다.");
        return;
      }
      if (pw2Wrap?.style.display !== "none" && password !== password2){
        showErr("비밀번호 확인이 일치하지 않습니다.");
        return;
      }

      setLoading(true);
      try{
        await tryRegister(username, nickname, email, password);
        showOk("가입 완료! 로그인 페이지로 이동합니다…");

        // login.html에서 자동 로그인
        sessionStorage.setItem('autoLogin', JSON.stringify({ u: username, p: password, next: nextUrl }));

        const loginUrl = new URL("{% url 'login' %}", window.location.origin);
        if (nextUrl) loginUrl.searchParams.set("next", nextUrl);
        location.href = loginUrl.toString();

      }catch(err){
        console.error("REGISTER ERROR:", err.status, err.payload || err);
        showErr(err.message || "가입 실패");
      }finally{
        setLoading(false);
      }
    });
  })();
  </script>
{% endblock %}
