{% extends "base.html" %}
{% load static %}
{% block title %}Workout Plan{% endblock %}

{% block extra_css %}
  {{ block.super }}
  <link rel="stylesheet" href="{% static 'css/styles.css' %}">
{% endblock %}

{% block content %}
<div class="workouts-shell">
  <header class="workouts-header">
    <div class="workouts-header__title">
      <h1>Your Workout Plan</h1>
      <p>AI-generated weekly sequence based on your goals</p>
    </div>
  </header>

  <!-- ✅ 플랜 툴바 -->
  <section class="workouts-week">
    <div class="workouts-week__header">
      <h2>
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <path d="M7 2v3m10-3v3M4 8h16M5 5h14a2 2 0 0 1 2 2v13a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2Z" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        This Week
      </h2>
      <div style="display:flex; gap:8px; align-items:center;">
        <input type="date" id="wk-plan-date" />
        <a class="health-button-secondary" href="#" id="wk-load-by-date">Load by Date</a>
        <a class="health-button-secondary" href="#" id="wk-ensure-today">Generate New Plan</a>
      </div>
    </div>

    <div class="workouts-week__days">
      {% for day in week_days %}
        <button type="button" class="workouts-week__day{% if forloop.first %} is-active{% endif %}">
          <span class="workouts-week__label">{{ day }}</span>
          <span class="workouts-week__date">{{ forloop.counter }}</span>
        </button>
      {% endfor %}
    </div>
  </section>

  <!-- ✅ 현재 플랜 표시 카드 -->
  {% comment %} <section id="wk-current-plan" class="dashboard-card" style="margin-top:12px; display:none;">
    <div class="dashboard-card__heading">
      <div>
        <h2>Current Plan</h2>
        <p class="dashboard-card__sub">
          Plan ID: <span id="wk-plan-id">-</span> ·
          Tasks: <span id="wk-plan-taskcount">0</span> ·
          Total: <span id="wk-plan-duration">0</span> min
        </p>
      </div>
    </div>

    <div id="wk-tasks-list" class="task-list"></div>

    {# ---------------------------------------------
       디버깅용: 서버 응답 전체(JSON) 확인할 때만 주석 해제해서 사용하세요.
       실제 서비스 UI에서는 감춰두는 것을 권장합니다.
    <details style="margin-top:8px;">
      <summary>Debug JSON</summary>
      <pre id="wk-plan-json" class="code"></pre>
    </details>
       --------------------------------------------- #}
  </section> {% endcomment %}

  <section class="workouts-list">
    {% for workout in workouts_plan %}
      <article class="workout-card">
        <header class="workout-card__header">
          <div>
            <h3>{{ workout.name }}</h3>
            <div class="workout-card__meta">
              <span class="workout-tag workout-tag--{{ workout.type }}">{{ workout.type }}</span>
              <span class="workout-tag workout-tag--{{ workout.difficulty }}">{{ workout.difficulty }}</span>
              <span class="workout-duration">{{ workout.duration }} min</span>
            </div>
          </div>
          {% if workout.completed %}
            <span class="workout-status workout-status--done">
              <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M5 12 10 17 19 7" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg>
              Completed
            </span>
          {% else %}
            <a class="workout-start" href="#"><span>▶</span>Start Workout</a>
          {% endif %}
        </header>

        <div class="workout-exercises">
          <h4>Exercises</h4>
          <ul>
            {% for exercise in workout.exercises %}
              <li>
                <span>{{ exercise.name }}</span>
                <span class="workout-exercises__detail">
                  {% if exercise.sets and exercise.reps %}
                    {{ exercise.sets }} × {{ exercise.reps }}
                  {% else %}
                    {{ exercise.duration }}s
                  {% endif %}
                </span>
              </li>
            {% endfor %}
          </ul>
        </div>
      </article>
    {% endfor %}
  </section>
</div>

<!-- ✅ 공용 모달 include -->
{% include "partials/plan_wizard.html" %}
{% endblock %}

{% block extra_js %}
  {{ block.super }}
  <script src="{% static 'js/workouts.js' %}"></script>
  <script>
    // 전역 API / authHeaders 는 base.html 제공

    // 현재 플랜 카드 렌더
    function renderCurrentPlan(plan) {
      const box   = document.getElementById('wk-current-plan');
      const idEl  = document.getElementById('wk-plan-id');
      const cntEl = document.getElementById('wk-plan-taskcount');
      const durEl = document.getElementById('wk-plan-duration');
      const list  = document.getElementById('wk-tasks-list');
      if (!box) return;

      const items = Array.isArray(plan?.tasks) ? plan.tasks : [];
      const totalMin = Number(plan?.total_duration_min ?? 0);

      idEl.textContent  = plan?.id ?? '-';
      cntEl.textContent = plan?.tasks_count ?? items.length;
      durEl.textContent = totalMin;

      list.innerHTML = items.length
        ? items.map(t => `
            <div class="task row between" data-id="${t.id}" style="padding:6px 0;border-bottom:1px solid #eee;">
              <div>
                <b>${t.exercise_detail?.name || t.exercise_name || '(exercise)'}</b>
                <span class="muted">
                  ${t.target_sets ?? '-'}x${t.target_reps ?? '-'} · ${t.intensity ?? '-'} · ${t.duration_min ?? 0}m
                </span>
              </div>
              <div class="row" style="gap:6px;">
                <button class="btn btn--ghost" data-action="log">Log</button>
                <button class="btn btn--ghost" data-action="delete">Delete</button>
              </div>
            </div>
          `).join('')
        : '<em>No tasks yet. Open the wizard and create tasks.</em>';

      // (옵션) 삭제 버튼 동작
      list.querySelectorAll('[data-action="delete"]').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const id = +e.currentTarget.closest('.task').dataset.id;
          if (!confirm('삭제할까요?')) return;
          const r = await fetch(`${API}/taskitems/${id}/`, { method: 'DELETE', headers: authHeaders() });
          if (r.ok || r.status === 204) await refreshCurrentPlan(); else alert('삭제 실패');
        });
      });

      box.style.display = 'block';
    }

    // 상세 재조회→카드 갱신
    async function refreshCurrentPlan() {
      if (!window.currentPlan?.id) return;
      const r = await fetch(`${API}/workoutplans/${window.currentPlan.id}/`, { headers: authHeaders() });
      if (!r.ok) return;
      const detail = await r.json();
      window.currentPlan = detail;
      renderCurrentPlan(detail);
    }

    // 오늘 플랜 생성
    document.getElementById('wk-ensure-today')?.addEventListener('click', async (e) => {
      e.preventDefault();
      if (window.openPlanWizard) window.openPlanWizard();

      const res = await fetch(`${API}/workoutplans/today/ensure/`, {
        method: 'POST',
        headers: authHeaders()
      });
      const plan = await res.json();
      if (!res.ok) return alert(plan.detail || "Failed to ensure today plan.");

      window.currentPlan = plan;
      renderCurrentPlan(plan);
      await refreshCurrentPlan();
    });

    // 날짜별 플랜 로드
    document.getElementById('wk-load-by-date')?.addEventListener('click', async (e) => {
      e.preventDefault();
      const d = document.getElementById('wk-plan-date').value;
      if (!d) return alert('날짜를 선택해 주세요.');

      const res = await fetch(`${API}/workoutplans/by-date/?date=${encodeURIComponent(d)}`, {
        headers: authHeaders()
      });
      const data = await res.json();
      if (!res.ok) return alert(data.detail || 'Load failed');

      const plans = Array.isArray(data) ? data : (Array.isArray(data?.results) ? data.results : []);
      if (!plans.length) return alert('해당 날짜 플랜 없음');

      window.currentPlan = plans[0];
      renderCurrentPlan(plans[0]);
      if (window.openPlanWizard) window.openPlanWizard();
      await refreshCurrentPlan();
    });

    // 진입 시 오늘 플랜 자동 로드 시도
    (async () => {
      const today = new Date().toISOString().slice(0,10);
      const r = await fetch(`${API}/workoutplans/by-date/?date=${today}`, { headers: authHeaders() });
      const data = await r.json().catch(()=>[]);
      const plans = Array.isArray(data) ? data : (Array.isArray(data?.results) ? data.results : []);
      if (r.ok && plans.length) {
        window.currentPlan = plans[0];
        renderCurrentPlan(plans[0]);
        await refreshCurrentPlan();
      }
    })();
  </script>
{% endblock %}
