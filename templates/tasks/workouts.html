{% extends "base.html" %}
{% load static %}
{% block title %}Workout Plan{% endblock %}

{% block extra_css %}
  {{ block.super }}
  <link rel="stylesheet" href="{% static 'css/styles.css' %}">
  <style>
    /* ìš”ì¼/ë‚ ì§œ ë°” + í˜ì´ì§€ë„¤ì´ì…˜ */
    .wk-bar{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between;margin-top:4px}
    .wk-days{display:flex;gap:8px;overflow:auto;padding:4px 0}
    .wk-day{border:1px solid #e5e7eb;border-radius:10px;padding:8px 10px;background:#fff;cursor:pointer}
    .wk-day.is-active{background:#111;color:#fff;border-color:#111}
    .wk-day .label{display:block;font-size:12px;opacity:.8}
    .wk-day .date{display:block;font-weight:700}
    .wk-pager{display:flex;gap:6px;align-items:center}
    .wk-pager .btn{padding:6px 10px}

    /* í˜„ì¬ í”Œëœ ì¹´ë“œ(í•˜ëŠ˜ìƒ‰ ì¹´ë“œ) */
    #wk-current-plan{margin-top:12px}
    #wk-current-plan .card{background:#e0f2fe;border:1px solid #93c5fd;border-radius:12px;padding:10px}
    #wk-current-plan .card *{color:#000}
    #wk-current-plan .card legend{background:#dbeafe;border:1px solid #93c5fd;border-radius:8px;padding:2px 8px;font-weight:700}
    #wk-current-plan .task{padding:6px 0;border-bottom:1px solid #eee}
  </style>
{% endblock %}

{% block content %}
<div class="workouts-shell">
  <header class="workouts-header">
    <div class="workouts-header__title">
      <h1>Your Workout Plan</h1>
      <p>AI-generated weekly sequence based on your goals</p>
    </div>
  </header>

  <!-- âœ… í”Œëœ íˆ´ë°” + ë‚ ì§œ/ìš”ì¼ ë°” -->
  <section class="workouts-week">
    <div class="workouts-week__header">
      <h2>
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <path d="M7 2v3m10-3v3M4 8h16M5 5h14a2 2 0 0 1 2 2v13a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2Z" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        This Week
      </h2>
      <div style="display:flex; gap:8px; align-items:center;">
        <input type="date" id="wk-plan-date" />
        <a class="health-button-secondary" href="#" id="wk-load-by-date" aria-label="ì„ íƒí•œ ë‚ ì§œ ë¡œë“œ">Load by Date</a>
        <a class="health-button-secondary" href="#" id="wk-ensure-today" aria-label="ì˜¤ëŠ˜ í”Œëœ ìƒì„± ë˜ëŠ” ë³´ì¥">Generate New Plan</a>

      </div>
    </div>

    <!-- ë‚ ì§œ/ìš”ì¼ + í˜ì´ì§€ë„¤ì´ì…˜ -->
    <div class="wk-bar">
      <div class="wk-days" id="wk-days"></div>
      <div class="wk-pager">
        <button class="btn btn--ghost" id="wk-prev-day" aria-label="ì´ì „ ë‚ ì§œë¡œ ì´ë™">â—€ Prev</button>
        <span id="wk-current-label" class="muted" aria-live="polite"></span>
        <button class="btn btn--ghost" id="wk-next-day" aria-label="ë‹¤ìŒ ë‚ ì§œë¡œ ì´ë™">Next â–¶</button>
      </div>
    </div>
  </section>

  <!-- âœ… í˜„ì¬ í”Œëœ í‘œì‹œ ì¹´ë“œ -->
  <section id="wk-current-plan" class="dashboard-card">
    <div class="dashboard-card__heading">
      <div>
        <h2>Current Plan</h2>
        <p class="dashboard-card__sub" role="group" aria-label="Current plan summary">
          Date: <span id="wk-plan-date-label" aria-live="polite">-</span> Â·
          Plan ID: <span id="wk-plan-id" aria-live="polite">-</span> Â·
          Tasks: <span id="wk-plan-taskcount" aria-live="polite">0</span> Â·
          Total: <span id="wk-plan-duration" aria-live="polite">0</span> min
        </p>
      </div>
    </div>
    <div id="wk-tasks-list"></div>
  </section>

  <!-- (ê¸°ì¡´ ë°ëª¨ ì¹´ë“œ ìœ ì§€ ì‹œ) -->
  <section class="workouts-list">
    {% for workout in workouts_plan %}
      <article class="workout-card">
        <header class="workout-card__header">
          <div>
            <h3>{{ workout.name }}</h3>
            <div class="workout-card__meta">
              <span class="workout-tag workout-tag--{{ workout.type }}">{{ workout.type }}</span>
              <span class="workout-tag workout-tag--{{ workout.difficulty }}">{{ workout.difficulty }}</span>
              <span class="workout-duration">{{ workout.duration }} min</span>
            </div>
          </div>
          {% if workout.completed %}
            <span class="workout-status workout-status--done">
              <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M5 12 10 17 19 7" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg>
              Completed
            </span>
          {% else %}
            <a class="workout-start" href="#"><span>â–¶</span>Start Workout</a>
          {% endif %}
        </header>

        <div class="workout-exercises">
          <h4>Exercises</h4>
          <ul>
            {% for exercise in workout.exercises %}
              <li>
                <span>{{ exercise.name }}</span>
                <span class="workout-exercises__detail">
                  {% if exercise.sets and exercise.reps %}
                    {{ exercise.sets }} Ã— {{ exercise.reps }}
                  {% else %}
                    {{ exercise.duration }}s
                  {% endif %}
                </span>
              </li>
            {% endfor %}
          </ul>
        </div>
      </article>
    {% endfor %}
  </section>
</div>

<!-- âœ… í”Œëœ ìœ„ìë“œ -->
{% include "partials/plan_wizard.html" %}
{% endblock %}

{% block extra_js %}
  {{ block.super }}
  <script src="{% static 'js/workouts.js' %}"></script>
  <script>
    // ========= ê³µí†µ =========
    const API = window.API || "/api";

    // CSRF í† í° ì½ê¸°
    function getCookie(name){
      const m = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
      return m ? m.pop() : '';
    }

    // ğŸ” ì•ˆì „í•œ í—¤ë” ë˜í¼: window.authHeaders ìˆìœ¼ë©´ ê·¸ê±¸ ì“°ê³ , ì—†ìœ¼ë©´ ê¸°ë³¸ í—¤ë” + CSRF ì‚¬ìš©
    const getAuthHeaders = (() => {
      const base = (typeof window.authHeaders === 'function') ? window.authHeaders.bind(window) : null;
      return () => {
        if (base) return base();
        const h = { 'Content-Type': 'application/json' };
        const csrf = getCookie('csrftoken');
        if (csrf) h['X-CSRFToken'] = csrf;
        return h;
      };
    })();

    // ========= ë‚ ì§œ ìœ í‹¸ (KST ê¸°ì¤€) =========
    function toKST(d){ return new Date(d.toLocaleString('en-US',{timeZone:'Asia/Seoul'})); }
    function startOfDayKST(d){ const t=toKST(d); return new Date(t.getFullYear(), t.getMonth(), t.getDate()); }
    function addDays(d, n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
    function fmtISO(d){ const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,'0'); const dd=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${dd}`; }
    const DAYS_KO = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];

    // ========= ìƒíƒœ =========
    const TODAY = startOfDayKST(new Date());
    const RANGE_START = addDays(TODAY, -59); // âœ… ìµœê·¼ 60ì¼(2ë‹¬)ë¡œ í™•ì¥
    const RANGE_END   = TODAY;

    let selectedDate = TODAY; // í˜„ì¬ ì„ íƒëœ ë‚ ì§œ

    // ========= DOM =========
    const $daysWrap      = document.getElementById('wk-days');
    const $dateInput     = document.getElementById('wk-plan-date');
    const $loadByDate    = document.getElementById('wk-load-by-date');
    const $ensureToday   = document.getElementById('wk-ensure-today');
    const $label         = document.getElementById('wk-current-label');

    const $planDateLabel = document.getElementById('wk-plan-date-label');
    const $planIdEl      = document.getElementById('wk-plan-id');
    const $planCntEl     = document.getElementById('wk-plan-taskcount');
    const $planMinEl     = document.getElementById('wk-plan-duration');
    const $list          = document.getElementById('wk-tasks-list');

    // ========= ì£¼(ì›”â†’ì¼) ë²„íŠ¼ ë Œë” =========
    function startOfWeekMon(d){
      const wd = d.getDay(); // 0=ì¼
      const diff = (wd === 0) ? -6 : (1 - wd); // ì›”=1
      return addDays(d, diff);
    }

    function renderWeekBar(centerDate){
      // centerDateê°€ ì†í•œ ì£¼ì˜ ì›”~ì¼ ìƒì„±
      const start = startOfWeekMon(centerDate);
      const days = Array.from({length:7}, (_,i)=>addDays(start,i));
      $daysWrap.innerHTML = days.map(d=>{
        const day = DAYS_KO[d.getDay()];
        const label = `${d.getMonth()+1}/${d.getDate()}`;
        const isActive = fmtISO(d) === fmtISO(selectedDate);
        return `
          <button type="button" class="wk-day ${isActive?'is-active':''}" data-date="${fmtISO(d)}">
            <span class="label">${day}</span>
            <span class="date">${label}</span>
          </button>
        `;
      }).join('');

      // í´ë¦­ ì‹œ ë¡œë“œ
      $daysWrap.querySelectorAll('.wk-day').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const iso = btn.dataset.date;
          const d = new Date(iso+'T00:00:00');
          selectDate(d, {load:true, rerender:true});
        });
      });

      // í˜„ì¬ ë¼ë²¨
      $label.textContent = `${selectedDate.getMonth()+1}/${selectedDate.getDate()} (${DAYS_KO[selectedDate.getDay()]})`;
    }

    function clampToRange(d){
      if (d < RANGE_START) return RANGE_START;
      if (d > RANGE_END) return RANGE_END;
      return d;
    }

    // ========= ë‚ ì§œ ì„ íƒ ì²˜ë¦¬ =========
    async function selectDate(d, opts={load:true, rerender:true}){
      selectedDate = clampToRange(startOfDayKST(d));
      if ($dateInput){
        $dateInput.value = fmtISO(selectedDate);
      }
      if (opts.rerender) renderWeekBar(selectedDate);
      if (opts.load) await loadPlanByDate(selectedDate);
    }

    // ========= ë‚ ì§œë³„ TaskItem ì¡°íšŒ (serializerì— tasks ì—†ì–´ë„ OK) =========
    async function fetchDayItems(iso){
      const r = await fetch(`${API}/taskitems/?date=${encodeURIComponent(iso)}`, {
        headers: getAuthHeaders(),
        credentials: 'same-origin',
      });
      if (!r.ok) return [];
      const data = await r.json().catch(()=>[]);
      return Array.isArray(data) ? data : (Array.isArray(data?.results) ? data.results : []);
    }

    // ========= í”Œëœ ë¡œë”© & ë Œë” (ì•ˆì „ ë²„ì „) =========
    async function loadPlanByDate(d){
      const iso = fmtISO(d);

      // 1) í•´ë‹¹ ë‚ ì§œì˜ í”Œëœ ì°¾ê¸° (ì—¬ëŸ¬ ê°œë©´ ì²« ë²ˆì§¸ ì‚¬ìš©)
      const r = await fetch(`${API}/workoutplans/by-date/?date=${encodeURIComponent(iso)}`, {
        headers: getAuthHeaders(),
        credentials: 'same-origin',
      });
      const data = await r.json().catch(()=>[]);
      const plans = Array.isArray(data) ? data : (Array.isArray(data?.results) ? data.results : []);

      // 2) í•´ë‹¹ ë‚ ì§œ TaskItem ì§ì ‘ ì¡°íšŒ
      const items = await fetchDayItems(iso);

      // ë¼ë²¨ ì—…ë°ì´íŠ¸
      $planDateLabel.textContent = iso;

      if (!r.ok || !plans.length){
        // í”Œëœì´ ì—†ì–´ë„ TaskItemì´ ìˆìœ¼ë©´ ê·¸ê²ƒë§Œ í‘œì‹œ
        $planIdEl.textContent  = '-';
        $planCntEl.textContent = items.length.toString();
        $planMinEl.textContent = items.reduce((s,x)=> s + (Number(x.duration_min)||0), 0).toString();

        $list.innerHTML = items.length
          ? items.map(t=>`
              <div class="task row between" data-id="${t.id}">
                <div>
                  <b>${t.exercise_detail?.name || t.exercise_name || '(exercise)'}</b>
                  <span class="muted">
                    ${(t.target_sets ?? '-') }x${(t.target_reps ?? '-') }
                    Â· ${t.intensity ?? '-'} Â· ${t.duration_min ?? 0}m
                  </span>
                </div>
              </div>
            `).join('')
          : '<em>í•´ë‹¹ ë‚ ì§œ í”Œëœ/í•­ëª© ì—†ìŒ</em>';

        window.currentPlan = undefined;
        return;
      }

      // 3) í”Œëœ 1ê°œ ì„ íƒ
      const plan = plans[0];
      window.currentPlan = plan; // IDë§Œ ìˆì–´ë„ ì¶©ë¶„

      // 4) ë¼ë²¨/ì¹´ìš´íŠ¸/í•©ê³„ ë° ë Œë”
      const totalMin = (plan.total_duration_min != null)
        ? Number(plan.total_duration_min)
        : items.reduce((s,x)=> s + (Number(x.duration_min)||0), 0);

      renderCurrentPlan(
        { id: plan.id, tasks: items, tasks_count: items.length, total_duration_min: totalMin },
        d
      );
    }

    // ========= ë Œë” =========
    function renderCurrentPlan(planLike, d){
      const items = Array.isArray(planLike?.tasks) ? planLike.tasks : [];
      $planDateLabel.textContent = fmtISO(d);
      $planIdEl.textContent      = planLike?.id ?? '-';
      $planCntEl.textContent     = planLike?.tasks_count ?? items.length;
      $planMinEl.textContent     = planLike?.total_duration_min ?? items.reduce((s,x)=> s + (Number(x.duration_min)||0), 0);

      $list.innerHTML = items.length
        ? items.map(t=>`
          <div class="task row between" data-id="${t.id}">
            <div>
              <b>${t.exercise_detail?.name || t.exercise_name || '(exercise)'}</b>
              <span class="muted">
                ${(t.target_sets ?? '-') }x${(t.target_reps ?? '-') }
                Â· ${t.intensity ?? '-'} Â· ${t.duration_min ?? 0}m
              </span>
            </div>
            <div class="row" style="gap:6px;">
              <button class="btn btn--ghost" data-action="delete">Delete</button>
            </div>
          </div>
        `).join('')
        : '<em>No tasks yet</em>';

      // ì‚­ì œ ë™ì‘(í”Œëœ ID ì—†ì´ë„ task idë§Œ ìˆìœ¼ë©´ ê°€ëŠ¥)
      $list.querySelectorAll('[data-action="delete"]').forEach(btn=>{
        btn.addEventListener('click', async (e)=>{
          const id = +e.currentTarget.closest('.task').dataset.id;
          if (!confirm('ì‚­ì œí• ê¹Œìš”?')) return;
          const r = await fetch(`${API}/taskitems/${id}/`, {
            method:'DELETE',
            headers: getAuthHeaders(),
            credentials: 'same-origin',
          });
          if (r.ok || r.status===204) await loadPlanByDate(selectedDate);
          else alert('ì‚­ì œ ì‹¤íŒ¨');
        });
      });

      // ë‹¤ë¥¸ ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ì¬ì‚¬ìš©í•  ìˆ˜ ìˆê²Œ ë…¸ì¶œ
      window.renderCurrentPlan = renderCurrentPlan;
    }

    // ========= ì´ˆê¸°í™” =========
    (function init(){
      // date input ë²”ìœ„/ì´ˆê¸°ê°’ (âœ… 60ì¼ ë²”ìœ„ ë°˜ì˜)
      if ($dateInput){
        $dateInput.min = fmtISO(RANGE_START);
        $dateInput.max = fmtISO(RANGE_END);
        $dateInput.value = fmtISO(TODAY);
      }

      // ì²˜ìŒ ì§„ì…: ì˜¤ëŠ˜ë¡œ ì„ íƒ + ë¡œë“œ
      selectDate(TODAY);

      // ë‚ ì§œ ì…ë ¥ â†’ ë¡œë“œ
      $loadByDate?.addEventListener('click', async (e)=>{
        e.preventDefault();
        const v = $dateInput?.value;
        if (!v) return alert('ë‚ ì§œë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.');
        selectDate(new Date(v+'T00:00:00'));
      });

      // ì˜¤ëŠ˜ í”Œëœ ë³´ì¥ + ìœ„ìë“œ ì—´ê¸° (ìˆœì„œ: ensure ë¨¼ì €)
      $ensureToday?.addEventListener('click', async (e) => {
        e.preventDefault();
        const btn = e.currentTarget;
        btn.disabled = true; // ì¤‘ë³µ í´ë¦­ ë°©ì§€

        try {
          // 1) ì˜¤ëŠ˜ ë‚ ì§œ ì„ íƒ(UI ì—…ë°ì´íŠ¸ë§Œ)
          await selectDate(TODAY, { load: false, rerender: true });

          // 2) ì˜¤ëŠ˜ í”Œëœ ë³´ì¥ â†’ ID í™•ë³´
          const res = await fetch(`${API}/workoutplans/today/ensure/`, {
            method: 'POST',
            headers: getAuthHeaders(),
            credentials: 'same-origin',
          });
          const plan = await res.json().catch(()=> ({}));
          if (!res.ok) {
            alert(plan.detail || 'Failed to ensure today plan.');
            return;
          }

          // 3) ì „ì—­ í˜„ì¬ í”Œëœ ì„¸íŒ…
          window.currentPlan = plan;

          // 4) ìƒì„¸ ì¬ë¡œë”©(Tasks ë“± ìµœì‹ )
          await loadPlanByDate(TODAY);

          // 5) ì´ì œ ìœ„ìë“œ ì—´ê¸° (ID ë³´ì¥ëœ ìƒíƒœ)
          if (typeof window.openPlanWizard === 'function') window.openPlanWizard();
        } catch (err) {
          console.error(err);
          alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ë¡œ í”Œëœ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        } finally {
          btn.disabled = false;
        }
      });

      // Prev/Next (âœ… ìµœê·¼ 60ì¼ ë‚´ë¶€)
      document.getElementById('wk-prev-day')?.addEventListener('click', ()=> selectDate(addDays(selectedDate,-1)));
      document.getElementById('wk-next-day')?.addEventListener('click', ()=> selectDate(addDays(selectedDate, 1)));

      // ìœ„ìë“œì—ì„œ ìƒì„± ì™„ë£Œ â†’ ì˜¤ëŠ˜/ì„ íƒì¼ ê°±ì‹ (ì´ë¯¸ plan_wizardì—ì„œ plan:updated ì´ë²¤íŠ¸ ì¨)
      window.addEventListener('plan:updated', (ev)=>{
        const plan = ev.detail || {};
        const created = plan?.created_at ? new Date(plan.created_at) : TODAY;
        const sameDay = fmtISO(created) === fmtISO(selectedDate);
        if (sameDay) loadPlanByDate(selectedDate);
        else if (fmtISO(created) === fmtISO(TODAY)) selectDate(TODAY);
      });
    })();
  </script>
{% endblock %}
