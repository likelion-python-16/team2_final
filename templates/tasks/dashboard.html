{% extends "base.html" %}
{% load static %}

{% block title %}AI 대시보드{% endblock %}

{% block extra_css %}
  {{ block.super }}
  <link rel="stylesheet" href="{% static 'css/styles.css' %}">
{% endblock %}

{% block content %}
<div class="dashboard-shell">
  <aside class="dashboard-glow" aria-hidden="true"></aside>

  <header class="dashboard-header">
    <div class="dashboard-header__text">
      <h1>Dashboard</h1>
      <p>AI 코칭과 함께 오늘의 목표를 확인하세요.</p>
    </div>
    <div class="dashboard-header__actions">
      <a class="btn btn--ghost" href="/users/profile/">Profile</a>
      <a class="btn btn--primary" href="#insights">AI Insights</a>
    </div>
  </header>

  <div class="dashboard-divider"></div>

  <!-- ✅ 플랜 툴바 -->
  <section id="plan-toolbar" class="dashboard-card" style="margin-bottom:16px;">
    <div class="dashboard-card__heading">
      <div>
        <h2>Workout Plan</h2>
        <p class="dashboard-card__sub">오늘 플랜 생성 또는 특정 날짜 불러오기</p>
      </div>
    </div>
    <div class="row" style="gap:8px; align-items:center;">
      <input type="date" id="plan-date" />
      <button class="btn btn--ghost" id="btn-load-by-date">Load by Date</button>
      <button class="btn btn--primary" id="btn-ensure-today">Generate New Plan (Today)</button>
    </div>
  </section>

  <main class="dashboard-layout">
    <section class="dashboard-column">
      <article class="dashboard-card dashboard-card--stat" id="progress" data-progress-total="{{ progress_total }}" data-progress-complete="{{ progress_done }}">
        <div class="progress-panel__header">
          <div>
            <h2>Today's Progress</h2>
            <p class="progress-panel__sub">{{ summary.total_minutes }} min of training · {{ summary.active_plans }} active plans</p>
          </div>
          <div class="progress-panel__complete">
            <span class="progress-panel__percent" id="progressPercent">{{ progress_complete }}%</span>
            <span class="progress-panel__caption">Complete</span>
          </div>
        </div>
        <div class="progress-ring-row" id="progressRings">
          {% for item in progress_cards %}
          <div class="progress-ring-wrap progress-ring-wrap--{{ item.color }}">
            {% include "partials/progress_ring.html" with wrapper_class="progress-ring--mini" progress=item.render_percent value=item.render_value label=item.label color=item.color %}
          </div>
          {% endfor %}
        </div>
        <div class="progress-goal">
          <div class="progress-goal__bar"><span id="progressGoalFill" style="width: 0%"></span></div>
          <p class="progress-goal__text" id="progressGoalLabel">
            <span id="progressGoalCount">{{ progress_done }}</span>
            of
            <span id="progressGoalTotal">{{ progress_total }}</span>
            daily goals completed
          </p>
        </div>
      </article>

      <!-- ✅ 플랜 Task 렌더 -->
      <article class="dashboard-card" id="plan-tasks">
        <div class="dashboard-card__heading">
          <div>
            <h2>Today's Tasks (from Plan)</h2>
            <p class="dashboard-card__sub">현재 로드된 플랜 기준</p>
          </div>
        </div>
        <div id="tasks-list"><em>No tasks yet</em></div>
      </article>

      <!-- 기존 Daily Tasks 카드 -->
      <article class="premium-card task-card" id="tasks">
        <div class="task-card__header">
          <div>
            <h3>Daily Tasks</h3>
            <p class="task-card__sub" data-task-count>오늘 목표 {{ daily_tasks|length }}개</p>
          </div>
          <div class="task-card__actions">
            <span class="task-card__calendar" aria-hidden="true">
              <svg viewBox="0 0 24 24" focusable="false">
                <path d="M7 2v3m10-3v3M4.5 8h15m-13 4h4" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" />
                <rect x="3" y="5" width="18" height="16" rx="3" ry="3" fill="none" stroke="currentColor" stroke-width="1.6" />
              </svg>
            </span>
            <button type="button" class="task-card__add" data-task-add aria-label="Add daily task">
              <svg viewBox="0 0 24 24" focusable="false" aria-hidden="true">
                <path d="M12 5v14m-7-7h14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
              </svg>
            </button>
          </div>
        </div>
        <ul class="task-card__list" id="dailyTasks">
          {% for task in daily_tasks %}
            <li class="task-card__item{% if task.completed %} is-complete{% endif %}" data-task-type="{{ task.type }}" data-completed="{{ task.completed|yesno:'true,false' }}">
              <label class="task-card__toggle">
                <input type="checkbox" class="task-card__input" data-task-checkbox {% if task.completed %}checked{% endif %}>
                <span class="task-card__checkbox" data-state="{% if task.completed %}checked{% else %}unchecked{% endif %}" aria-hidden="true">
                  <svg viewBox="0 0 24 24" focusable="false">
                    <path d="M20 6 9 17l-5-5" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="3" />
                  </svg>
                </span>
                <span class="task-card__text{% if task.completed %} is-complete{% endif %}">{{ task.text }}</span>
                <span class="task-card__dot task-card__dot--{{ task.type }}" aria-hidden="true"></span>
              </label>
            </li>
          {% endfor %}
        </ul>
      </article>

      <article class="dashboard-card" id="insights">
        <div class="dashboard-card__heading">
          <div>
            <h2>AI Insights</h2>
            <p class="dashboard-card__sub dashboard-card__sub--dark">Updated daily</p>
          </div>
          <span class="badge">Today</span>
        </div>
        <div class="insight-stack">
          {% if ai_loading %}{% include "partials/ai_thinking_dots.html" %}{% endif %}
          {% for insight in ai_insights %}
            <div class="insight insight--{{ insight.type }}">
              <div class="insight__header">
                <h3>{{ insight.title }}</h3>
                <span class="muted">Confidence {{ insight.confidence }}%</span>
              </div>
              <p>{{ insight.message }}</p>
            </div>
          {% endfor %}
        </div>
      </article>
    </section>

    <section class="dashboard-column">
      <article class="dashboard-card" id="recommend">
        <div class="dashboard-card__heading">
          <div>
            <h2>Today's Recommendations</h2>
            <p class="dashboard-card__sub">Tailored picks for you</p>
          </div>
        </div>
        <ul class="recommend-list">
          {% for task in recommendations %}
            <li class="recommend-list__item">
              <div>
                <strong>{{ task.exercise.name }}</strong>
                <span class="muted"> · {{ task.duration_min }} min</span>
              </div>
              <span class="pill">Priority {{ forloop.counter }}</span>
            </li>
          {% empty %}
            <li class="muted">No recommended workouts yet. Update your goals to get suggestions.</li>
          {% endfor %}
        </ul>
      </article>

      <article class="premium-card quick-actions-card">
        <div class="quick-actions__header">
          <h3>Quick Actions</h3>
          <p>Jump right into today's tasks</p>
        </div>
        <div class="quick-actions__grid">
          {% for action in quick_actions %}
            <a href="{{ action.url }}" class="quick-action quick-action--{{ action.variant }}" data-quick-action>
              <span class="quick-action__icon" aria-hidden="true">
                {% if action.icon == 'zap' %}
                  <svg viewBox="0 0 24 24" focusable="false"><path d="M13 2 3 14h7l-1 8 10-12h-7Z" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" /></svg>
                {% elif action.icon == 'camera' %}
                  <svg viewBox="0 0 24 24" focusable="false"><path d="M12 10a3 3 0 1 0 0 6 3 3 0 0 0 0-6Zm-9 9V8a3 3 0 0 1 3-3h2.2a1 1 0 0 0 .83-.44l.94-1.41A1.5 1.5 0 0 1 11.18 2h1.64a1.5 1.5 0 0 1 1.21.65l.94 1.41a1 1 0 0 0 .83.44H18a3 3 0 0 1 3 3v11a3 3 0 0 1-3 3H6a3 3 0 0 1-3-3Z" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" /></svg>
                {% elif action.icon == 'trend' %}
                  <svg viewBox="0 0 24 24" focusable="false"><path d="m3 17 6-6 4 4 7-7" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" /></svg>
                {% else %}
                  <svg viewBox="0 0 24 24" focusable="false"><path d="M12 21a9 9 0 1 0-9-9 9 9 0 0 0 9 9Zm0-5a4 4 0 1 0-4-4 4 4 0 0 0 4 4Zm0-4h.01" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" /></svg>
                {% endif %}
              </span>
              <span class="quick-action__content">
                <span class="quick-action__title">{{ action.title }}</span>
                <span class="quick-action__caption">{{ action.caption }}</span>
              </span>
            </a>
          {% endfor %}
        </div>
      </article>

      <article class="dashboard-card">
        <div class="dashboard-card__heading">
          <div>
            <h2>Nutrition Upload</h2>
            <p class="dashboard-card__sub">Keep your meals tracked with AI</p>
          </div>
        </div>
        {% include "partials/meal_upload.html" %}
      </article>
    </section>
  </main>

  <a class="floating-button" href="#" aria-label="빠른 추가">＋</a>
</div>

<!-- ✅ 공용 모달 include -->
{% include "partials/plan_wizard.html" %}
{% endblock %}

{% block extra_js %}
  {{ block.super }}
  <script src="{% static 'js/dashboard.js' %}"></script>
  <script>
    // 오늘 플랜 생성
    document.getElementById('btn-ensure-today')?.addEventListener('click', async () => {
      if (window.openPlanWizard) window.openPlanWizard();
      const res = await fetch(`${API}/workoutplans/today/ensure/`, {
        method: 'POST',
        headers: authHeaders()
      });
      const plan = await res.json();
      if (!res.ok) return alert(plan.detail || "Failed to ensure today plan.");
      window.currentPlan = plan;
      renderTasks(plan);
    });

    // 날짜별 플랜 로드
    document.getElementById('btn-load-by-date')?.addEventListener('click', async () => {
      const d = document.getElementById('plan-date').value;
      if (!d) return alert('날짜를 선택해 주세요.');
      const res = await fetch(`${API}/workoutplans/by-date/?date=${encodeURIComponent(d)}`, {
        headers: authHeaders()
      });
      const data = await res.json();
      if (!res.ok) return alert(data.detail || 'Load failed');

      const plans = Array.isArray(data) ? data : (Array.isArray(data?.results) ? data.results : []);
      if (!plans.length) return alert('해당 날짜 플랜 없음');
      window.currentPlan = plans[0];
      renderTasks(plans[0]);
    });

    // 플랜 Task 렌더
    async function renderTasks(plan) {
      const container = document.getElementById('tasks-list');
      if (!container || !plan) return;
      const res = await fetch(`${API}/workoutplans/${plan.id}/`, {
        headers: authHeaders()
      });
      const p = await res.json();
      if (!res.ok) return container.innerText = 'Load failed';

      container.innerHTML = (p.tasks || []).map(t => `
        <div class="task row between" data-id="${t.id}" style="padding:8px 0;border-bottom:1px solid #f0f0f0;">
          <div>
            <b>${t.exercise_detail?.name || t.exercise_name}</b>
            <span class="muted"> ${t.target_sets || '-'}x${t.target_reps || '-'} · ${t.intensity || '-'}</span>
          </div>
          <div class="row" style="gap:6px;">
            <button class="btn btn--ghost btn-edit">Edit</button>
            <button class="btn btn--ghost btn-log">Log</button>
          </div>
        </div>
      `).join('') || '<em>No tasks yet</em>';

      container.querySelectorAll('.btn-edit').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const id = +e.target.closest('.task').dataset.id;
          const reps = prompt('새 목표 횟수?', '12'); if (!reps) return;
          const r = await fetch(`${API}/taskitems/${id}/`, {
            method: 'PATCH',
            headers: authHeaders(),
            body: JSON.stringify({ target_reps: +reps })
          });
          if (r.ok) renderTasks(plan); else alert('수정 실패');
        });
      });

      container.querySelectorAll('.btn-log').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const id = +e.target.closest('.task').dataset.id;
          const task = (p.tasks || []).find(x=>x.id===id) || {};
          const rpe = prompt('체감 강도(1~10)?', '7');
          const notes = prompt('메모', '');
          const payload = {
            workout_plan: p.id,
            task_item: id,
            exercise: task.exercise,
            date: new Date().toISOString().slice(0,10),
            duration_min: task.duration_min || 0,
            kcal_burned: 0,
            perceived_exertion: rpe ? +rpe : null,
            notes: notes || ''
          };
          const r = await fetch(`${API}/workoutlogs/`, {
            method:'POST',
            headers: authHeaders(),
            body: JSON.stringify(payload)
          });
          if (r.ok) alert('저장 완료'); else alert('저장 실패');
        });
      });
    }

    // 첫 진입 시 오늘 플랜 자동 로드(있으면)
    (async () => {
      const today = new Date().toISOString().slice(0,10);
      const r = await fetch(`${API}/workoutplans/by-date/?date=${today}`, {
        headers: authHeaders()
      });
      const data = await r.json();
      const plans = Array.isArray(data) ? data : (Array.isArray(data?.results) ? data.results : []);
      if (r.ok && plans.length) {
        window.currentPlan = plans[0];
        renderTasks(plans[0]);
      }
    })();
  </script>
{% endblock %}
