{% extends "base.html" %}
{% load static %}
{% block title %}AI 대시보드{% endblock %}

{% block extra_head %}
  {{ block.super }}
  <link rel="stylesheet" href="{% static 'css/styles.css' %}">
{% endblock %}

{% block content %}
<div class="dashboard-shell">
  <aside class="dashboard-glow" aria-hidden="true"></aside>

  <header class="dashboard-header">
    <div class="dashboard-header__text">
      <h1>Dashboard</h1>
      <p>AI 코칭과 함께 오늘의 목표를 확인하세요.</p>
    </div>
    <div class="dashboard-header__actions">
      <a class="btn btn--ghost" href="/users/profile/">Profile</a>
      <a class="btn btn--primary" href="#insights">AI Insights</a>
    </div>
  </header>

  <div class="dashboard-divider"></div>

  <main class="dashboard-layout">
    <!-- ====== Column A ====== -->
    <section class="dashboard-column">

      <!-- Today Summary (운동/식단/목표 합계) -->
      <article class="dashboard-card dashboard-card--stat">
        <div class="dashboard-card__heading">
          <div>
            <h2>Today Summary</h2>
            <p class="dashboard-card__sub">운동 · 식단 · 목표 한눈에 보기</p>
          </div>
          <span class="badge">Today</span>
        </div>

        <div class="grid grid--3">
          <!-- 운동 합계 -->
          <div class="stat-tile">
            <div class="stat-tile__label">Workout Minutes</div>
            <div class="stat-tile__value">
              {{ today_totals.workout_minutes|default:0 }}<span class="stat-tile__unit"> min</span>
            </div>
          </div>

          <!-- 식단 합계 -->
          <div class="stat-tile">
            <div class="stat-tile__label">Calories / Macros</div>
            <div class="stat-tile__value">
              {{ today_totals.meals.calories|default:0 }}<span class="stat-tile__unit"> kcal</span>
            </div>
            <div class="stat-tile__sub">
              P {{ today_totals.meals.protein|default:0 }}g ·
              C {{ today_totals.meals.carbs|default:0 }}g ·
              F {{ today_totals.meals.fat|default:0 }}g
            </div>
          </div>

          <!-- 목표 합계 -->
          <div class="stat-tile">
            <div class="stat-tile__label">Daily Goals</div>
            <div class="stat-tile__value">
              {{ today_totals.goals.completed|default:0 }}<span class="stat-tile__unit"> / </span>{{ today_totals.goals.total|default:0 }}
            </div>
          </div>
        </div>
      </article>

      <!-- Progress -->
      <article
        class="dashboard-card dashboard-card--stat"
        id="progress"
        data-progress-total="{{ progress_total }}"
        data-progress-complete="{{ progress_done }}"
      >
        <div class="progress-panel__header">
          <div>
            <h2>Today's Progress</h2>
            <p class="progress-panel__sub">
              {{ summary.total_minutes|default:0 }} min of training · {{ summary.active_plans|default:0 }} active plans
            </p>
          </div>
          <div class="progress-panel__complete">
            <span class="progress-panel__percent" id="progressPercent">{{ progress_complete|default:0 }}%</span>
            <span class="progress-panel__caption">Complete</span>
          </div>
        </div>

        <div class="progress-ring-row" id="progressRings">
          {% for item in progress_cards %}
            <div class="progress-ring-wrap progress-ring-wrap--{{ item.color }}">
              {% include "partials/progress_ring.html" with wrapper_class="progress-ring--mini" progress=item.render_percent value=item.render_value label=item.label color=item.color %}
            </div>
          {% endfor %}
        </div>

        <div class="progress-goal">
          <div class="progress-goal__bar"><span id="progressGoalFill" style="width: 0%"></span></div>
          <p class="progress-goal__text" id="progressGoalLabel">
            <span id="progressGoalCount">{{ progress_done|default:0 }}</span>
            of
            <span id="progressGoalTotal">{{ progress_total|default:0 }}</span>
            daily goals completed
          </p>
        </div>
      </article>

      <!-- Daily Tasks -->
      <article class="premium-card task-card" id="tasks">
        <div class="task-card__header">
          <div>
            <h3>Daily Tasks</h3>
            <p class="task-card__sub" data-task-count>오늘 목표 {{ daily_tasks|length }}개</p>
          </div>
          <div class="task-card__actions">
            <span class="task-card__calendar" aria-hidden="true">
              <svg viewBox="0 0 24 24" focusable="false">
                <path d="M7 2v3m10-3v3M4.5 8h15m-13 4h4" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" />
                <rect x="3" y="5" width="18" height="16" rx="3" ry="3" fill="none" stroke="currentColor" stroke-width="1.6" />
              </svg>
            </span>
            <button type="button" class="task-card__add" data-task-add aria-label="Add daily task">
              <svg viewBox="0 0 24 24" focusable="false" aria-hidden="true">
                <path d="M12 5v14m-7-7h14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
              </svg>
            </button>
          </div>
        </div>

        <ul class="task-card__list" id="dailyTasks">
          {% for task in daily_tasks %}
            <li
              class="task-card__item{% if task.completed %} is-complete{% endif %}"
              data-task-type="{{ task.type }}"
              data-completed="{{ task.completed|yesno:'true,false' }}"
            >
              <label class="task-card__toggle">
                <input type="checkbox" class="task-card__input" data-task-checkbox {% if task.completed %}checked{% endif %}>
                <span
                  class="task-card__checkbox"
                  data-state="{% if task.completed %}checked{% else %}unchecked{% endif %}"
                  aria-hidden="true"
                >
                  <svg viewBox="0 0 24 24" focusable="false">
                    <path d="M20 6 9 17l-5-5" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="3" />
                  </svg>
                </span>
                <span class="task-card__text{% if task.completed %} is-complete{% endif %}">{{ task.text }}</span>
                <span class="task-card__dot task-card__dot--{{ task.type }}" aria-hidden="true"></span>
              </label>
            </li>
          {% endfor %}
        </ul>
      </article>

      <!-- AI Insights -->
      <article class="dashboard-card" id="insights">
        <div class="dashboard-card__heading">
          <div>
            <h2>AI Insights</h2>
            <p class="dashboard-card__sub dashboard-card__sub--dark">Updated daily</p>
          </div>
          <span class="badge">Today</span>
        </div>
        <div class="insight-stack">
          {% if ai_loading %}{% include "partials/ai_thinking_dots.html" %}{% endif %}
          {% for insight in ai_insights %}
            <div class="insight insight--{{ insight.type }}">
              <div class="insight__header">
                <h3>{{ insight.title }}</h3>
                <span class="muted">Confidence {{ insight.confidence }}%</span>
              </div>
              <p>{{ insight.message }}</p>
            </div>
          {% endfor %}
        </div>
      </article>
    </section>

    <!-- ====== Column B ====== -->
    <section class="dashboard-column">

      <!-- Recommendations -->
      <article class="dashboard-card" id="recommend">
        <div class="dashboard-card__heading">
          <div>
            <h2>Today's Recommendations</h2>
            <p class="dashboard-card__sub">Tailored picks for you</p>
          </div>
        </div>
        <ul class="recommend-list">
          {% for task in recommendations %}
            <li class="recommend-list__item">
              <div>
                <strong>{{ task.exercise.name }}</strong>
                <span class="muted"> · {{ task.duration_min }} min</span>
              </div>
              <span class="pill">Priority {{ forloop.counter }}</span>
            </li>
          {% empty %}
            <li class="muted">No recommended workouts yet. Update your goals to get suggestions.</li>
          {% endfor %}
        </ul>
      </article>

      <!-- Quick Actions -->
      <article class="premium-card quick-actions-card">
        <div class="quick-actions__header">
          <h3>Quick Actions</h3>
          <p>Jump right into today's tasks</p>
        </div>
        <div class="quick-actions__grid">
          {% for action in quick_actions %}
            <a href="{{ action.url }}" class="quick-action quick-action--{{ action.variant }}" data-quick-action>
              <span class="quick-action__icon" aria-hidden="true">
                {% if action.icon == 'zap' %}
                  <svg viewBox="0 0 24 24" focusable="false"><path d="M13 2 3 14h7l-1 8 10-12h-7Z" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" /></svg>
                {% elif action.icon == 'camera' %}
                  <svg viewBox="0 0 24 24" focusable="false"><path d="M12 10a3 3 0 1 0 0 6 3 3 0 0 0 0-6Zm-9 9V8a3 3 0 0 1 3-3h2.2a1 1 0 0 0 .83-.44l.94-1.41A1.5 1.5 0 0 1 11.18 2h1.64a1.5 1.5 0 0 1 1.21.65l.94 1.41a1 1 0 0 0 .83.44H18a3 3 0 0 1 3 3v11a3 3 0 0 1-3 3H6a3 3 0 0 1-3-3Z" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" /></svg>
                {% elif action.icon == 'trend' %}
                  <svg viewBox="0 0 24 24" focusable="false"><path d="m3 17 6-6 4 4 7-7" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" /></svg>
                {% else %}
                  <svg viewBox="0 0 24 24" focusable="false"><path d="M12 21a9 9 0 1 0-9-9 9 9 0 0 0 9 9Zm0-5a4 4 0 1 0-4-4 4 4 0 0 0 4 4Zm0-4h.01" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" /></svg>
                {% endif %}
              </span>
              <span class="quick-action__content">
                <span class="quick-action__title">{{ action.title }}</span>
                <span class="quick-action__caption">{{ action.caption }}</span>
              </span>
            </a>
          {% endfor %}
        </div>
      </article>

      <!-- Nutrition Upload -->
      <article class="dashboard-card">
        <div class="dashboard-card__heading">
          <div>
            <h2>Nutrition Upload</h2>
            <p class="dashboard-card__sub">Keep your meals tracked with AI</p>
          </div>
        </div>
        {% include "partials/meal_upload.html" %}
      </article>
    </section>
  </main>

  <a class="floating-button" href="#" aria-label="빠른 추가">＋</a>
</div>
{% endblock %}

{% block extra_js %}
  {{ block.super }}
  <script src="{% static 'js/dashboard.js' %}"></script>
{% endblock %}
