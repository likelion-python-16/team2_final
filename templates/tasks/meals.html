{% extends "base.html" %}
{% load static %}

{% block title %}ì˜ì–‘ ê´€ë¦¬{% endblock %}

{% block extra_head %}
  {{ block.super }}
  <link rel="stylesheet" href="{% static 'css/meals.css' %}">
{% endblock %}

{% block content %}
<div class="meals-shell">
  <header class="meals-header">
    <div class="meals-header__inner">
      <h1>ì˜ì–‘ ì½”ì¹˜</h1>
      <p>AIê°€ ë‚¨ì€ ì˜ì–‘ì†Œì— ë§ì¶° ì‹ë‹¨ì„ ì œì•ˆí•´ ë“œë¦½ë‹ˆë‹¤</p>
    </div>
  </header>

  <main class="meals-main">
    <!-- ì˜¤ëŠ˜ì˜ ì˜ì–‘ í˜„í™© -->
    <section class="meals-card">
      <h2>ì˜¤ëŠ˜ì˜ ì˜ì–‘ í˜„í™©</h2>
      <!-- â˜… ì¶”ê°€: ìš”ì•½ í•œ ì¤„ í‘œì‹œ -->
      <p id="wp-summary-line" class="muted" hidden></p>

      <div class="meal-summary-grid">
        {% for item in nutrition_summary %}
          <div class="meal-summary" data-goal="{{ item.goal }}">
            <div class="meal-summary__value meal-summary__value--{{ item.color }}">
              <span>{{ item.current }}</span>
              <span class="meal-summary__unit">/ {{ item.goal }} {{ item.unit }}</span>
            </div>
            <div class="meal-progress">
              <span class="meal-progress__fill meal-progress__fill--{{ item.color }}" style="--progress: {{ item.progress }}%;"></span>
            </div>
            <p class="meal-summary__label">{{ item.label }}</p>
          </div>
        {% endfor %}
      </div>

      {% for card in ai_feedback_cards %}
        <div class="ai-feedback-card ai-feedback-card--{{ card.type }}">
          <span class="ai-feedback-card__icon" aria-hidden="true">
            {% if card.type == 'suggestion' %}
              <svg viewBox="0 0 24 24" focusable="false"><path d="M12 2a7 7 0 0 0-4 12.74V18a2 2 0 0 0 2 2h4v-1.5h-3v-1.88A7 7 0 0 0 12 2Z" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg>
            {% else %}
              <svg viewBox="0 0 24 24" focusable="false"><path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2Zm0 6v4" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/><circle cx="12" cy="16" r=".8" fill="currentColor"/></svg>
            {% endif %}
          </span>
          <p>{{ card.message }}</p>
        </div>
      {% endfor %}
    </section>

    <!-- ì‹ë‹¨ ì‚¬ì§„ ì—…ë¡œë“œ -->
    <section class="meals-card">
      <h2 class="meals-card__title">
        <span class="meals-card__icon" aria-hidden="true">
          <svg viewBox="0 0 24 24" focusable="false"><path d="M4 7h3l2-3h6l2 3h3a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2Zm8 3a4 4 0 1 0 4 4 4 4 0 0 0-4-4Z" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </span>
        ì‹ë‹¨ ì‚¬ì§„ ì—…ë¡œë“œ
      </h2>

      <div class="meal-photo" data-meal-photo-widget>
        <!-- ë¹ˆ ìƒíƒœ -->
        <div class="meal-photo__empty" data-photo-empty>
          <div class="meal-photo__icon" aria-hidden="true">
            <svg viewBox="0 0 24 24" focusable="false"><path d="M12 16v-8m0 0-3 3m3-3 3 3M6.5 19h11a2.5 2.5 0 0 0 0-5h-.3a4.8 4.8 0 0 0-9.4 0h-.3a2.5 2.5 0 0 0 0 5Z" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
          </div>
          <div class="meal-photo__text">
            <p class="meal-photo__title">ì‹ì‚¬ ì‚¬ì§„ì„ ì°ê±°ë‚˜ ì—…ë¡œë“œí•˜ì„¸ìš”</p>
            <p class="meal-photo__subtitle">AIê°€ ìë™ìœ¼ë¡œ ì—´ëŸ‰ê³¼ ì˜ì–‘ì†Œë¥¼ ì¶”ì í•©ë‹ˆë‹¤</p>
          </div>
          <label class="meal-photo__button">
            <input type="file" accept="image/*" class="sr-only" data-photo-input>
            <span>ì‚¬ì§„ ì—…ë¡œë“œ</span>
          </label>
        </div>

        <!-- í”„ë¦¬ë·° -->
        <div class="meal-photo__preview" data-photo-preview hidden>
          <img src="" alt="ì„ íƒí•œ ì‹ì‚¬" data-photo-image>
          <div class="meal-photo__actions">
            <button type="button" class="btn btn--ghost btn--sm" data-photo-reset>ë‹¤ë¥¸ ì‚¬ì§„ ì„ íƒ</button>
          </div>
        </div>

        <!-- ë¡œë”© -->
        <div class="meal-photo__loading" data-photo-loading hidden>
          <span class="spinner" aria-hidden="true"></span>
          <p>AIê°€ ì‚¬ì§„ì„ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤â€¦</p>
        </div>

        <!-- ë¶„ì„ ê²°ê³¼ -->
        <div class="meal-photo__analysis-wrap" hidden data-analysis-container>
          <article class="meal-photo__analysis" id="mealAnalysisCard">
            <header>
              <h3 id="mealAnalysisTitle">ë¶„ì„ ê²°ê³¼</h3>
              <span class="meal-photo__label" id="mealAnalysisLabel"></span>
            </header>
            <p class="meal-photo__confidence" id="mealAnalysisConfidence"></p>
            <p class="meal-photo__serving muted" id="mealAnalysisServing" hidden></p>

            <!-- 100g ê¸°ì¤€ / ì´í•© í‘œì‹œ -->
            <div class="meal-analysis__macros-wrap">
              <div class="meal-analysis__row">
                <strong>ì´í•©(1íšŒ ì œê³µëŸ‰):</strong>
                <div class="meal-history__macros" id="mealAnalysisMacrosTotal"></div>
              </div>
              <div class="meal-analysis__row">
                <span class="muted">100g ê¸°ì¤€(ì°¸ê³ ):</span>
                <div class="meal-history__macros" id="mealAnalysisMacrosPer100"></div>
              </div>
            </div>

            <p class="meal-photo__note" id="mealAnalysisNote" hidden></p>
            <div class="meal-photo__alternatives" id="mealAnalysisAlternatives" hidden></div>

            <!-- ì €ì¥ ë²„íŠ¼ -->
            <div class="meal-photo__actions">
              <button type="button" class="btn btn--primary" data-photo-commit hidden>ì €ì¥í•˜ê¸°</button>
            </div>

            <!-- ì»¤ë°‹ ì—ëŸ¬ -->
            <div class="ai-feedback-card ai-feedback-card--suggestion" id="mealCommitError" hidden></div>
          </article>
        </div>

        <!-- ë¶„ì„ ì—ëŸ¬ -->
        <div class="ai-feedback-card ai-feedback-card--suggestion" id="mealAnalysisError" hidden></div>
      </div>
    </section>

    <!-- ì˜¤ëŠ˜ì˜ ì‹ì‚¬ íˆìŠ¤í† ë¦¬ -->
    <section class="meals-card meals-card--history">
      <h2 class="meals-card__title">
        <span class="meals-card__icon" aria-hidden="true">
          <svg viewBox="0 0 24 24" focusable="false"><path d="M4 7h3l2-3h6l2 3h3a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2Zm8 3a4 4 0 1 0 4 4 4 4 0 0 0-4-4Z" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </span>
        ì˜¤ëŠ˜ì˜ ì‹ì‚¬
      </h2>

      <div class="meal-history" id="mealHistoryList">
        {% if meal_history %}
          {% for item in meal_history %}
            <article class="meal-history__item" data-history-item data-item-id="{{ item.id }}">
              <div class="meal-history__thumb" aria-hidden="true">
                {% if item.photo_url %}
                  <img src="{{ item.photo_url }}" alt="{{ item.name|default:'ì‹ì‚¬ ì‚¬ì§„' }}">
                {% else %}
                  <span class="meal-history__emoji">ğŸ¥—</span>
                {% endif %}
              </div>
              <div class="meal-history__info">
                <div class="meal-history__title-row">
                  <strong>{{ item.name }}</strong>
                  <span class="badge badge--subtle meal-type--{{ item.type_class }}">{{ item.meal_type }}</span>
                  {% if item.source == 'AI' %}
                    <span class="badge badge--ai"><span aria-hidden="true">âš¡</span>AI</span>
                  {% endif %}
                </div>
                <span class="meal-history__calories">{{ item.calories|floatformat:0 }} cal</span>
              </div>
              <div class="meal-history__macros">
                <span><strong>{{ item.protein|floatformat:0 }}g</strong> protein</span>
                <span><strong>{{ item.carbs|floatformat:0 }}g</strong> carbs</span>
                <span><strong>{{ item.fat|floatformat:0 }}g</strong> fat</span>
              </div>
              <button type="button" class="meal-history__delete" data-history-delete data-item-id="{{ item.id }}" aria-label="ì‹ì‚¬ ì‚­ì œ">Ã—</button>
            </article>
          {% endfor %}
        {% else %}
          <p class="meal-history__empty" data-history-empty>ì˜¤ëŠ˜ ê¸°ë¡ëœ ì‹ì‚¬ê°€ ì•„ì§ ì—†ìŠµë‹ˆë‹¤.</p>
        {% endif %}
      </div>
    </section>

    <!-- AI ì‹ì‚¬ ì¶”ì²œ (ì €ë…) -->
    <section class="meals-card">
      <h2 class="meals-card__title">
        <span class="meals-card__icon" aria-hidden="true">
          <svg viewBox="0 0 24 24" focusable="false"><path d="M13 2 3 14h7l-1 8 10-12h-7Z" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </span>
        AI Recommendations
      </h2>

      <div class="ai-recommendations"
           data-dinner-remaining-cal="{{ remaining_macros.calories }}"
           data-dinner-remaining-protein="{{ remaining_macros.protein }}"
           data-dinner-remaining-carbs="{{ remaining_macros.carbs }}"
           data-dinner-remaining-fat="{{ remaining_macros.fat }}">

        {% for rec in ai_recommendations %}
          {% if rec.title %}
            <div class="ai-recommendation-card">
              <h3>{{ rec.title }}</h3>
              <p>{{ rec.message }}</p>
              {% if rec.button %}
                <button type="button" class="ai-recommendation-card__button" data-fetch-dinner>{{ rec.button }}</button>
              {% endif %}
            </div>
          {% else %}
            <div class="ai-feedback-card ai-feedback-card--{{ rec.type }}">
              <span class="ai-feedback-card__icon" aria-hidden="true">
                <svg viewBox="0 0 24 24" focusable="false"><path d="M12 2a7 7 0 0 0-4 12.74V18a2 2 0 0 0 2 2h4v-1.5h-3v-1.88A7 7 0 0 0 12 2Z" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg>
              </span>
              <p>{{ rec.message }}</p>
            </div>
          {% endif %}
        {% endfor %}

        <div class="ai-recommendation-card ai-recommendation-card--result" id="dinnerRecipeOutput" hidden>
          <h3 id="dinnerRecipeTitle"></h3>
          <p class="muted" id="dinnerRecipeMacros"></p>
          <div id="dinnerRecipeBody"></div>
          <a id="dinnerRecipeLink" href="#" target="_blank" rel="noopener" class="ai-recommendation-card__button" hidden>ë ˆì‹œí”¼ ë§í¬ ì—´ê¸°</a>
        </div>

        <div class="ai-feedback-card ai-feedback-card--suggestion" id="dinnerRecipeError" hidden></div>
      </div>
    </section>
  </main>

  <button type="button" class="floating-action-button meals-fab" aria-label="Add meal">
    <svg viewBox="0 0 24 24" focusable="false"><path d="M12 5v14m-7-7h14" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg>
  </button>

  <nav class="meals-bottom-nav" aria-label="Quick navigation">
    <a href="{% url 'tasks:dashboard' %}" class="meals-bottom-nav__item">
      <span aria-hidden="true">ğŸ </span>
      <span>Dashboard</span>
    </a>
    <a href="{% url 'tasks:workouts' %}" class="meals-bottom-nav__item">
      <span aria-hidden="true">ğŸ’ª</span>
      <span>Workouts</span>
    </a>
    <a href="{% url 'tasks:meals' %}" class="meals-bottom-nav__item is-active">
      <span aria-hidden="true">ğŸ¥—</span>
      <span>Meals</span>
    </a>
    <a href="#" class="meals-bottom-nav__item">
      <span aria-hidden="true">âš™ï¸</span>
      <span>Settings</span>
    </a>
  </nav>
</div>
{% endblock %}

{% block extra_js %}
  {{ block.super }}
  <script src="{% static 'js/meals.js' %}?v=5.3-fix"></script>
  <script>
  /* í˜ì´ì§€ ë¡œë“œ ì‹œ ìš”ì•½ ì¬ì¡°íšŒ: JWTëŠ” api.authFetch ì‚¬ìš© */
  document.addEventListener("DOMContentLoaded", async () => {
    try {
      const date = new Date().toISOString().slice(0,10);
      const s = await api.authFetch(`/api/workoutplans/summary/?date=${date}`);

      // ìµœì†Œ ë³´ì¥: í•œ ì¤„ ìš”ì•½ í‘œì‹œ
      const line = document.getElementById("wp-summary-line");
      if (line) {
        line.textContent = `ì˜¤ëŠ˜ ìš´ë™ ${s.total_min ?? 0}ë¶„ Â· ${s.tasks_count ?? 0}ê°œ ì¤‘ ${s.completed_count ?? 0} ì™„ë£Œ Â· ì¹¼ë¡œë¦¬ ${s.calories ?? 0}kcal`;
        line.hidden = false;
      }

      // ì „ìš© ê°±ì‹  í•¨ìˆ˜ê°€ ìˆìœ¼ë©´ í˜¸ì¶œ
      if (typeof window.updateMealsSummaryUI === "function") {
        window.updateMealsSummaryUI(s);
      } else if (typeof window.updateSummaryUI === "function") {
        window.updateSummaryUI(s);
      } else {
        console.debug("[meals] summary", s);
      }
    } catch (e) {
      console.error(api.toUserMessage(e));
    }
  });
  </script>
{% endblock %}
