{% load static %}
<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{% block title %}Healthcare{% endblock %}</title>

  <!-- 폰트 & 전역 CSS -->
  <link rel="icon" href="{% static 'favicon.ico' %}" type="image/x-icon">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'css/styles.css' %}">

  {% block extra_css %}{% endblock %}

  <!-- ✅ 전역 API 유틸 (head에 두어도 안전) -->
  <script src="{% static 'js/common/api.js' %}"></script>

  <!-- ✅ (기존 authHeaders 유틸 — api.js와 겹치지만 삭제는 안 하고 둠) -->
  <script>
    (function() {
      function getCookie(name) {
        const cookies = document.cookie ? document.cookie.split('; ') : [];
        for (let i = 0; i < cookies.length; i++) {
          const parts = cookies[i].split('=');
          const key = decodeURIComponent(parts[0]);
          if (key === name) {
            return decodeURIComponent(parts.slice(1).join('='));
          }
        }
      }

      window.CSRF_TOKEN = getCookie('csrftoken') || '';
      window.API = window.API || '/api';

      window.authHeaders = function(extra) {
        const headers = Object.assign({
          'Content-Type': 'application/json'
        }, extra || {});

        if (window.CSRF_TOKEN && !headers['X-CSRFToken']) {
          headers['X-CSRFToken'] = window.CSRF_TOKEN;
        }

        try {
          const access = localStorage.getItem('access');
          if (access && !headers['Authorization']) {
            headers['Authorization'] = `Bearer ${access}`;
          }
        } catch (_) {
          // 로컬스토리지 미지원 환경은 무시
        }

        return headers;
      };
    })();
  </script>
</head>
<body>
  <!-- 헤더(기존 partial 감싸기) -->
  <header class="site-header">
    <div class="container row between center">
      {% include 'partials/navbar.html' %}
    </div>
  </header>

  <main>
    {% block content %}{% endblock %}
  </main>
  {% include "partials/auth_banner.html" %}
  <script src="{% static 'js/common/auth.state.js' %}"></script>

  <!-- 푸터(기존 partial 감싸기) -->
  <!-- ✅ 공통 UI 유틸 (body 끝에 두는 게 안전) -->
  <script src="{% static 'js/common/ui.js' %}"></script>
  <!-- 공통 날짜 유틸 -->
  <script src="{% static 'js/common/date.js' %}"></script>

  <!-- 페이지별 스크립트 -->
  {% block extra_js %}{% endblock %}
  <script>
  // 전역 인증 fetch (401 핸들 포함)
  window.authFetch = async function(url, opts = {}) {
    const token = localStorage.getItem('access');
    const headers = { ...(opts.headers || {}) };
    if (token) headers.Authorization = `Bearer ${token}`;
    // JSON 편의
    if (opts.json) {
      headers['Content-Type'] = 'application/json';
      opts.body = JSON.stringify(opts.json);
      delete opts.json;
    }
    const res = await fetch(url, { ...opts, headers });
    if (res.status === 401) {
      // 토큰 없음/만료 → 로그인으로 유도 (필요 시 refresh 로직을 다음 단계에서 붙이자)
      console.warn('Unauthorized -> redirect to login');
      window.location.href = '/accounts/login/?next=' + encodeURIComponent(window.location.pathname + window.location.search);
      throw new Error('Unauthorized');
    }
    return res;
  };
</script>
{% include "partials/auth_modal.html" %}
<script src="{% static 'js/common/ui.auth.js' %}"></script>
{% include "partials/toast.html" %}
<script src="{% static 'js/common/ui.toast.js' %}"></script>


</body>
</html>
